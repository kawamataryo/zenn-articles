---
title: "GitHub Trendingã‚’å®šæœŸçš„ã«ã¤ã¶ã‚„ãTwitter Botã‚’Firebaseã§ä½œã£ã¦ã¿ãŸ"
emoji: "ğŸ’¬"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Firebase", "TypeScript", "GitHub", "Twiter"]
published: true
---

# ğŸ“¦ ä½œã£ãŸã‚‚ã®

[GitHub Trending](https://github.com/trending)ã«æ²è¼‰ã•ã‚ŒãŸãƒªãƒã‚¸ãƒˆãƒªã‚’å®šæœŸçš„ã«ã¤ã¶ã‚„ã Twitter Bot ã‚’ä½œã‚Šã¾ã—ãŸã€‚
å…¨ä½“ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’ã¤ã¶ã‚„ã Bot ã¨ã€JavaScriptãƒ»TypeScript ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’ã¤ã¶ã‚„ã Bot ã® 2 ç¨®é¡ãŒã‚ã‚Šã¾ã™ã€‚

|[@gh_trending_](https://twitter.com/gh_trending_)|[@gh_trending_js](https://twitter.com/gh_trending_js)|
|---|---|
|![](https://user-images.githubusercontent.com/11070996/132124873-b698f5ee-5f7f-4d71-93bb-fd52763c7603.png)|![](https://user-images.githubusercontent.com/11070996/132124876-5f8ba485-231c-4008-8fe3-e628e4b547b9.png)|

ä»•æ§˜ã¯ã“ã¡ã‚‰ã§ã™ã€‚

- 30 åˆ†ã‹ã‚‰ 1 æ™‚é–“ãŠãã« GitHub Trending ã«æ²è¼‰ã•ã‚Œã¦ã„ã‚‹ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒ„ã‚¤ãƒ¼ãƒˆ
- ä¸€åº¦ãƒ„ã‚¤ãƒ¼ãƒˆãŸãƒªãƒã‚¸ãƒˆãƒªã¯å†åº¦æ²è¼‰ã•ã‚Œã¦ã„ã¦ã‚‚ 1 é€±é–“ã¯ã¤ã¶ã‚„ã‹ãªã„
- æŠ•ç¨¿å†…å®¹ã¯ãƒªãƒã‚¸ãƒˆãƒªåã€URLã€ã‚¹ã‚¿ãƒ¼æ•°ã€ä½œè€…ã® Twitter ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã€è¨€èªã€æ¦‚è¦

https://twitter.com/gh_trending_js/status/1435200188352765955

æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã¯ Firebase Cloud Functions ã¨ Firebase Firestore ã§ã™ã€‚
å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã¯å…¨ã¦ä»¥ä¸‹ãƒªãƒã‚¸ãƒˆãƒªã§å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚

https://github.com/kawamataryo/github-trending-bot


# ğŸ’ª ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³

è¤‡æ•°ã®ã¤ã‚ˆã„äººã‹ã‚‰ GitHub Trending ã‚’å®šæœŸçš„ã«è¦‹ã¦æœ€æ–°ã®æƒ…å ±ã‚’ã‚­ãƒ£ãƒƒãƒã‚¢ãƒƒãƒ—ã—ã¦ã„ã‚‹ã¨ã„ã†è©±ã‚’èã„ãŸã®ãŒã¯ã˜ã¾ã‚Šã§ã™ã€‚è‡ªåˆ†ã‚‚è¦‹ã‚‹ç¿’æ…£ã‚’ã¤ã‘ã‚ˆã†ã¨æ€ã£ãŸã®ã§ã™ãŒãªã‹ãªã‹ç¶šã‹ãšã€ãã‚Œãªã‚‰æ¯æ—¥è¦‹ã‚‹ Twitter ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã§è¦‹ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚Œã°ã‚ˆã„ã®ã§ã¯ï¼Ÿã€€ã¨æ€ æƒ°ãªãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã˜ã‚ã¾ã—ãŸã€‚

:::message
æœ€åˆã«æ—¢å­˜ã® GitHub Trending ã‚’ã¤ã¶ã‚„ã Twitter Bot ãŒãªã„ã‹æ¢ã—ã¾ã—ãŸã€‚ãŸã ã€[@TrendingGitHub](https://twitter.com/trendinggithub)ã‚„ã€[@github_trending](https://twitter.com/github_trending)ãªã©è¤‡æ•°è¦‹ã¤ã‹ã‚‹ã‚‚ã®ã®ã€å¤§æŠµ 2019 å¹´ã‚ãŸã‚Šã§æ›´æ–°ãŒæ­¢ã¾ã£ã¦ã„ãŸã®ã§è‡ªåˆ†ã§ä½œã£ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚
:::


# ğŸ¯ æŠ€è¡“çš„ãªãƒã‚¤ãƒ³ãƒˆ

## GitHub Trendingã®ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±ã®å–å¾—
GitHub Trending ã®ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±ã¯ã€GitHub å…¬å¼ã® API ãŒãªã‹ã£ãŸã®ã§ã€å®šæœŸçš„ã«ãƒšãƒ¼ã‚¸ã‚’ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã—ã¦å–å¾—ã—ã¦ã„ã¾ã™ã€‚

Node.js ã§ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã¨ã„ãˆã° Puppeteer ã‚„ Playwright ã§ã™ãŒã€ä»Šå›ã¯ GitHub Trending ã®ãƒšãƒ¼ã‚¸ãŒé™çš„ãªãƒšãƒ¼ã‚¸ã ã£ãŸã®ã§ã€å˜ç´”ã« GET ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã¦ãã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã® HTML ã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ã¨ã„ã†æ–¹æ³•ã§è¡Œã£ã¦ã„ã¾ã™ã€‚

HTML ã®ãƒ‘ãƒ¼ã‚¹ã«ã¯[node-html-parser](https://www.npmjs.com/package/node-html-parser)ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

https://www.npmjs.com/package/node-html-parser

[functions/src/lib/ghTrendScraper.ts](https://github.com/kawamataryo/github-trending-bot/blob/main/functions/src/lib/ghTrendScraper.ts)
```ts:functions/src/lib/ghTrendingScrapper.ts
export class GHTrendScraper {
  static async scraping(params = ""): Promise<GHTrend[]> {
    const res = await got.get(`https://github.com/trending${params}`);
    const dom = parse(res.body);
    const rows = dom.querySelectorAll(".Box-row");

    return await Promise.all(
      rows.map(async (row) => {
        const { owner, repository } = GHTrendScraper.getOwnerAndRepoName(row);
        const { description } = GHTrendScraper.getDescription(row);
        const { starCount } = GHTrendScraper.getStarCount(row);
        const { forkCount } = GHTrendScraper.getForkCount(row);
        const { todayStarCount } = GHTrendScraper.getTodayStarCount(row);
        const { language } = GHTrendScraper.getLanguage(row);
        const { ownersTwitterAccount } =
          await GHTrendScraper.getOwnersTwitterAccount(owner);

        return {
          owner,
          repository,
          language: language ?? "",
          description: description ?? "",
          starCount: starCount ?? "",
          forkCount: forkCount ?? "",
          todayStarCount: todayStarCount ?? "",
          ownersTwitterAccount: ownersTwitterAccount ?? "",
          url: `https://github.com/${owner}/${repository}`,
        };
      })
    );
  }

  private static getOwnerAndRepoName(dom: HTMLElement) {
    const path = dom.querySelector("> h1 a").attributes.href;
    const result = path.split("/");
    return {
      owner: result[1],
      repository: result[2],
    };
  }
  // ...
}
```

ãã—ã¦ã€ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã§å–å¾—ã—ãŸæƒ…å ±ã¯ Firestore ã«ä¿å­˜ã—ã¦ã„ã¾ã™ã€‚
ãã®æ™‚ã®ä¿å­˜æ¡ä»¶ã¨ã—ã¦ã€1 é€±é–“ä»¥å†…ã«ã™ã§ã«è¿½åŠ æ¸ˆã¿ã®ãƒªãƒã‚¸ãƒˆãƒªã¯é™¤å¤–ã—ã¦ã„ã¾ã™ã€‚

[functions/src/lib/firestore.ts](https://github.com/kawamataryo/github-trending-bot/blob/main/functions/src/lib/firestore.ts)

```ts
//...
const getTrendDataWithinOneWeek = async (
  collectionRef: FirebaseFirestore.CollectionReference
): Promise<GHTrend[]> => {
  const oneWeekAgo = dayjs().add(-7, "day").unix();
  const querySnapshotFromOneWeekAgo = await collectionRef
    .where("createdAt", ">=", oneWeekAgo)
    .get();
  return querySnapshotFromOneWeekAgo.docs.map((doc) => doc.data() as GHTrend);
};

export const bulkInsertTrends = async (
  collectionRef: FirebaseFirestore.CollectionReference,
  trends: GHTrend[]
): Promise<void> => {
  const trendsFromOneWeekAgo = await getTrendDataWithinOneWeek(collectionRef);

  await Promise.all(
    trends.map(async (trend) => {
      // exclude repositories submitted within a week.
      if (trendsFromOneWeekAgo.some((d) => d.url === trend.url)) {
        return Promise.resolve();
      }
      return await collectionRef.add({
        ...trend,
        createdAt: dayjs().unix(),
        tweeted: false,
      });
    })
  );
};

//...
```

:::message
ä»Šå›ã¯å¾Œè¿°ã™ã‚‹ãƒªãƒã‚¸ãƒˆãƒªã‚ªãƒ¼ãƒŠãƒ¼ã® Twitter ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå–å¾—ã®ãŸã‚ã«ã‚‚ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã§è‰¯ã‹ã£ãŸã®ã§ã™ãŒã€ã‚‚ã£ã¨ç°¡å˜ã«è¡Œã†ã®ãªã‚‰éå…¬å¼ã® GitHub Trending ã® API ä½¿ã†ã“ã¨ã‚‚å…¨ç„¶ã‚ã‚Šã ã¨æ€ã„ã¾ã™ã€‚
https://github.com/huchenme/github-trending-api
:::

### ãƒ„ã‚¤ãƒ¼ãƒˆã®å®šæœŸå®Ÿè¡Œ

ãƒ„ã‚¤ãƒ¼ãƒˆã¯ Functions ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã§ 30 åˆ†ã”ã¨ã«è¡Œã£ã¦ã„ã¾ã™ã€‚
ã“ã®æ™‚ã®ãƒ„ã‚¤ãƒ¼ãƒˆå†…å®¹ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã§å–å¾—ã—ãŸ Firestore ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

https://firebase.google.com/docs/functions/schedule-functions?hl=ja

[functions/src/pubsub/index.ts](https://github.com/kawamataryo/github-trending-bot/blob/main/functions/src/pubsub/index.ts)

```ts
export const tweetTrend = functions.pubsub
  .schedule("every 30 minutes")
  .onRun(async (_context) => {
    try {
      await Promise.all([tweetAllLanguagesTrends(), tweetFrontendTrends()]);
    } catch (e) {
      console.error(e);
    }
  });
```

Titter API ã‚’å©ãéš›ã«ã¯ Twitter-api-v2 ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

https://www.npmjs.com/package/twitter-api-v2

[functions/src/lib/twitter/index.ts](https://github.com/kawamataryo/github-trending-bot/blob/main/functions/src/lib/twitter.ts)

```ts
// ...
const createTweetText = (trend: GHTrend): string => {
  return `
ğŸ“¦ ${trend.repository}${
    trend.ownersTwitterAccount ? `\nğŸ‘¤ ${trend.ownersTwitterAccount}` : ""
  }
â­ ${trend.starCount} (+${trend.todayStarCount})${
    trend.language ? `\nğŸ—’ ${trend.language}` : ""
  }
${trend.description ? `\n${truncateText(trend.description, 85)}\n` : ""}
${trend.url}
`.trim();
};

const tweetFromTrend = async (
  client: TwitterApi,
  trend: GHTrend
): Promise<void> => {
  await client.v1.tweet(createTweetText(trend));
};

export const tweetRepository = async (
  collectionRef: FirebaseFirestore.CollectionReference,
  twitterClient: TwitterApi
): Promise<void> => {
  const snapshot = await getUntweetedTrend(collectionRef);
  if (snapshot.empty) {
    console.log("No matching documents.");
    return;
  }
  for (const doc of snapshot.docs) {
    await tweetFromTrend(twitterClient, doc.data() as GHTrend);
    await updateTweetedFlag(doc, true);
  }
};
```

# ğŸ›  å·¥å¤«ã—ãŸã¨ã“ã‚

## 1ã¤ã®Functionsã§å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’åˆ†ã‘ã‚‹

ãƒ‡ãƒ¼ã‚¿ã‚’é›†ã‚ã‚‹ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã€é›†ã‚ãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®ãƒ„ã‚¤ãƒ¼ãƒˆã®å®Ÿè¡Œã¯ç•°ãªã‚‹å‡¦ç†ãªã®ã§ã€åˆ¥ã® Functions ã§å®šç¾©ã—ãŸã»ã†ãŒã‚·ãƒ³ãƒ—ãƒ«ãªã®ã§ã™ãŒã€Firebase ã«ã¯ Functions ã®å®šæœŸå®Ÿè¡Œæ©Ÿèƒ½ãŒ 1 ã¤ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ 3 ã¤ã¾ã§ã¨ã„ã†åˆ¶é™ãŒã‚ã‚‹ã®ã§ã€ä»Šå›ã¯ 1 ã¤ã®é–¢æ•°ã®ä¸­ã§å®Ÿè¡Œæ™‚é–“ã‚’è¦‹ã¦å‡¦ç†ã‚’é–“å¼•ãã¨ã„ã†å½¢ã§ãã‚Œãã‚Œã®å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’åˆ¶å¾¡ã—ã¦ã„ã¾ã™ã€‚
ã‚ã¾ã‚Šè‰¯ã„ã‚„ã‚Šæ–¹ã§ã‚‚ãªã„ã®ã‹ã‚‚ã§ã™ãŒã€ä»Šã®æ‰€è‰¯ã„æ„Ÿã˜ã«æ©Ÿèƒ½ã—ã¦ã„ã¾ã™ã€‚

[functions/src/lib/core/frontend.ts](https://github.com/kawamataryo/github-trending-bot/blob/main/functions/src/lib/core/frontend.ts)

```ts:functions/src/lib/core/frontend.ts
// ...
export const tweetFrontendTrends = async (): Promise<void> => {
  // update trends data at several times a day.
  if (isUpdateTime()) {
    await updateFrontendTrends();
    console.info("Update frontend repositories collections");
  }

  // tweet trends repository with a bot
  await tweetRepository(collectionRef, twitterClient);
};
// ...
```

[functions/src/lib/lib/utils.ts](https://github.com/kawamataryo/github-trending-bot/blob/main/functions/src/lib/lib/utils.ts)

```ts:functions/src/lib/lib/utils.ts
// ...
export const isUpdateTime = (): boolean => {
  const datetime = dayjs();
  return datetime.hour() % 2 === 0 && datetime.minute() <= 30;
};
// ...
```

## ãƒªãƒã‚¸ãƒˆãƒªã‚ªãƒ¼ãƒŠãƒ¼ã®Twitterã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã™ã‚‹
ãƒ„ã‚¤ãƒ¼ãƒˆå¯¾è±¡ã®ãƒªãƒã‚¸ãƒˆãƒªã®ã‚ªãƒ¼ãƒŠãƒ¼ãƒšãƒ¼ã‚¸ã«ã€Twitter ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãƒ„ã‚¤ãƒ¼ãƒˆæ™‚ã«ãã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚
Twitter ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æƒ…å ±ã¯ãƒˆãƒ¬ãƒ³ãƒ‰ã®ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°æ™‚ã«ä¸€ç·’ã«å–å¾—ã—ã¦ã„ã¾ã™ã€‚

[functions/src/lib/ghTrendScraper.ts](https://github.com/kawamataryo/github-trending-bot/blob/main/functions/src/lib/ghTrendScraper.ts)
```ts
// ...
  private static async getOwnersTwitterAccount(owner?: string) {
    if (!owner) {
      return {
        ownersTwitterAccount: null,
      };
    }
    const res = await got.get(`https://github.com/${owner}`);
    const dom = parse(res.body);
    const ownersTwitterAccount = dom
      .querySelector(".vcard-details a[href^=\"https://twitter.com\"]")
      ?.innerText.trim();
    return {
      ownersTwitterAccount,
    };
  }
// ...
```

ç‹™ã„ã¨ã—ã¦ã¯ã€GitHub Trending ã«æ²è¼‰ã•ã‚ŒãŸã“ã¨ã‚’æœ¬äººã‚‚ã—ã‚‰ãªã„ã¨æ€ã†ã®ã§çŸ¥ã‚‰ã›ã¦ä¸Šã’ãŸã„ã¨ã„ã†æ°—æŒã¡ 1 å‰²ã€ãã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‹ã‚‰ã“ã® Twitter ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒèªçŸ¥ã•ã‚Œã¦ãƒªãƒã‚¸ãƒˆãƒªã‚ªãƒ¼ãƒŠãƒ¼ã®ãƒªãƒ„ã‚¤ãƒ¼ãƒˆã‹ã‚‰æµ·å¤–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚‚åºƒãŒã‚‰ãªã„ã‹ãªã¨ã„ã†æ‰“ç®—çš„ãªç‹™ã„ 9 å‰²ã¯ã§ã™ğŸ˜…

å®Ÿéš›ã«ã‚„ã£ã¦ã¿ã‚‹ã¨ã„ãã¤ã‹ã®æŠ•ç¨¿ã¯ãƒªãƒ„ã‚¤ãƒ¼ãƒˆã—ã¦ã‚‚ã‚‰ãˆã¦ãã“ã‹ã‚‰æµ·å¤–ã®ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãŒå¢—ãˆã¦ã„ã‚‹ã®ã§ä¸€å®šã®åŠ¹æœã¯ã‚ã‚Šãã†ã§ã™ã€‚

https://twitter.com/gh_trending_/status/1435320986912575489

# çµ‚ã‚ã‚Šã«
åˆã‚ã¦ã® Twitter Bot ã®ä½œæˆã ã£ãŸã®ã§ã™ãŒã€æ€ã„ã®ä»–ç°¡å˜ã«å‡ºæ¥ã¾ã—ãŸã€‚Firebase æœ€é«˜ï¼
ã¾ãŸã€ãƒªãƒªãƒ¼ã‚¹å¾Œ 2 æ—¥ã§ã™ã§ã« 200 äººä»¥ä¸Šã®æ–¹ã«ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã‚‚ã‚‰ãˆã¦å¬‰ã—ã„ã§ã™ã€‚ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°ã¨ã—ã¦ç›®ã«è¦‹ãˆã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ãŒã‚ã‹ã‚‹ã®ã¯è‰¯ã„ã§ã™ã­ã€‚

å½“åˆã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³é€šã‚Šã€GitHub Trending ã®ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰æŠ€è¡“ã‚­ãƒ£ãƒƒãƒã‚¢ãƒƒãƒ—ã—ã¦ã€ã¤ã‚ˆã„ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚’ç›®æŒ‡ã—ã¦é ‘å¼µã‚ŠãŸã„ã§ã™ã€‚