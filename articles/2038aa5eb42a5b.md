---
title: "Recastã§ASTã‚’æ¢ç´¢ã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’å‹•çš„ã«å¤‰æ›ã™ã‚‹"
emoji: "ğŸ§©"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["recast", "ast", "javascript"]
published: false
---

Recastã‚’ä½¿ã£ã¦ã¿ãŸã‚‰ä¾¿åˆ©ã ã£ãŸã®ã§ç´¹ä»‹ã§ã™ã€‚

# ğŸ› ï¸ Recastã¨ã¯ï¼Ÿ

https://github.com/benjamn/recast

Recastã¯ã€JavaScriptã®ASTï¼ˆæŠ½è±¡æ§‹æ–‡æœ¨ï¼‰ã‚’æ¢ç´¢ãƒ»æ“ä½œã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚ASTã‚’æ‰±ã†ãŸã‚ã®ä¾¿åˆ©ãªé–¢æ•°ãŒè±Šå¯Œã«æä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚

å¤§è¦æ¨¡ãªã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã§ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚„ã€ç‰¹å®šã®ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è‡ªå‹•ä¿®æ­£ãƒ„ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹éš›ã«åˆ©ç”¨ã§ãã¾ã™ã€‚

## åŸºæœ¬çš„ãªä½¿ã„æ–¹

ã‚³ãƒ¼ãƒ‰ã‚’æ¢ç´¢ãƒ»æ“ä½œã™ã‚‹æµã‚Œã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

1. `parse`ã§ã‚³ãƒ¼ãƒ‰ã‚’ASTã«å¤‰æ›ã™ã‚‹
2. `visit`ã§ASTã‚’æ¢ç´¢ã—ã¦ã€ç‰¹å®šã®Nodeã‚’è¦‹ã¤ã‘ã‚‹
3. Nodeã‚’æ”¹å¤‰ã™ã‚‹
4. `print`ã§ASTã‚’ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›ã™ã‚‹

ç°¡å˜ãªä¾‹ã¨ã—ã¦ã€fooã¨ã„ã†å¤‰æ•°åã‚’barã«å¤‰æ›´ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```js
import { parse, visit, print } from "recast";

const code = `const foo = 'hello world';`;

// ã‚³ãƒ¼ãƒ‰æ–‡å­—åˆ—ã‚’ASTã«å¤‰æ›
const ast = parse(code);

// ASTã‚’æ¢ç´¢
visit(ast, {
  // æ¢ç´¢ä¸­ã«Identifierã‚’è¦‹ã¤ã‘ãŸã‚‰è¡Œã†å‡¦ç†ã‚’ç™»éŒ²
  visitIdentifier(path) {
    const { node } = path;
    // å¤‰æ•°åãŒfooã®å ´åˆã¯barã«å¤‰æ›´
    if (node.name === "foo") {
        node.name = "bar";
    }
    return false;
  },
});

// const bar = 'hello world';
console.log(print(ast).code);
```

## ä¾¿åˆ©ãªãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°

Nodeã®ãƒã‚§ãƒƒã‚¯ã‚„ã€æ”¹å¤‰ã«ä¾¿åˆ©ãªãªãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚‚æä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚

### namedTypes

`namedTypes` ã§ã¯ASTã®Nodeã®å‹ã‚’è¡¨ã™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€å‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹éš›ã«åˆ©ç”¨ã§ãã¾ã™ã€‚

```js
import { types } from "recast";

const n = types.namedTypes;

// nodeãŒCallExpressionã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
if (n.CallExpression.check(node)) {
  // ...
}
```

### builders

`builders`ã«ã¯ASTã®Nodeã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®é–¢æ•°ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€æ–°ã—ã„Nodeã‚’ç”Ÿæˆã™ã‚‹éš›ã«åˆ©ç”¨ã§ãã¾ã™ã€‚

```js
import { types } from "recast";

const b = types.builders;

// æ–°ã—ã„CallExpressionã‚’ç”Ÿæˆ
const newCallExpression = b.callExpression(
  b.identifier("add"),
  [b.literal("1"), b.literal("2")]
);

// add(1, 2)
print(newCallExpression).code;
```

### prettyPrint

ã‚‚ã—ã€å‡ºåŠ›æ™‚ã«ã‚³ãƒ¼ãƒ‰ã‚’ã„ã„æ„Ÿã˜ã«æ•´å½¢ã—ãŸã„å ´åˆã¯ã€`prettyPrint` ãŒåˆ©ç”¨ã§ãã¾ã™ã€‚

```js
import { prettyPrint } from "recast";

const code = `
const foo = 1 +
2
`;

const ast = parse(code);

// const foo = 1 +
// 2
console.log(print(ast).code);

// const foo = 1 + 2;
console.log(prettyPrint(ast).code);
```

## è¤‡æ•°ã®ãƒ‘ãƒ¼ã‚µãƒ¼ã«å¯¾å¿œ

Recastã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ã¨ã€[Esprima JavaScript parser](https://www.npmjs.com/package/esprima)ã«å¯¾å¿œã—ã¦ã„ã¾ã™ãŒã€`parse`ã®ç¬¬2å¼•æ•°ã«ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ä»–ã®ãƒ‘ãƒ¼ã‚µãƒ¼ã«ã‚‚å¤‰æ›´ã§ãã¾ã™ã€‚

TypeScriptã‚„JSXã®ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã†å ´åˆãªã©ã«å¤‰æ›´ã™ã‚‹ã¨ä¾¿åˆ©ã§ã™ã€‚

:::message
TypeScript, flow, babelã®ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’ä½¿ã†å ´åˆã¯äº‹å‰ã« `@babel/parser` ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
:::

```js
import { parse } from "recast";
import TSParser from "recast/parsers/typescript";

const code = `
  function hello(name: string): string {
    return 'hello ' + name;
  }
`;

// TypeScriptã®ASTã«å¤‰æ›
const ast = parse(code, {
  parser: TSParser
});
```

# ğŸ§‘â€ğŸ’» å®Ÿä¾‹

ä»¥ä¸‹ç°¡å˜ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã”ã¨ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã™ã€‚

## ç‰¹å®šã®ã‚³ãƒ¼ãƒ‰ã‚’ç½®æ›ã™ã‚‹

`let`ã‚’`const`ã«ç½®æ›ã™ã‚‹å ´åˆã€‚

```js
const replaceLetToConst = (code: string) => {
  const ast = parse(code);
  visit(ast, {
    visitVariableDeclaration(path) {
      const { node } = path;
      if (node.kind === "let") {
        node.kind = "const";
      }
      return false;
    },
  });
  return print(ast).code;
}
```

ğŸ§ª ãƒ†ã‚¹ãƒˆ

```js
test("replace let to const", () => {
  const code = `
    let hello = 'hello';
    let world = 'world';
  `;
  const result = replaceLetToConst(code);
  expect(result).toBe(`
    const hello = 'hello';
    const world = 'world';
  `);
})
```

## ç‰¹å®šã®ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã™ã‚‹

ã‚³ãƒ¼ãƒ‰ä¸Šã®`console.log`ã‚’å‰Šé™¤ã™ã‚‹å ´åˆã€‚

```js
const removeConsoleLog = (code: string) => {
  const ast = parse(code);
  visit(ast, {
    visitExpressionStatement(path) {
      const { node } = path;
      if (
        n.CallExpression.check(node.expression) &&
        n.MemberExpression.check(node.expression.callee) &&
        n.Identifier.check(node.expression.callee.object) &&
        node.expression.callee.object.name === "console" &&
        n.Identifier.check(node.expression.callee.property) &&
        node.expression.callee.property.name === "log"
      ) {
        path.prune();
      }
      return false;
    },
  });
  return print(ast).code;
}
```

ğŸ§ª ãƒ†ã‚¹ãƒˆ

```js
test("remove console.log", () => {
  const code = `
    console.log('hello world');

    function helloWorld() {
      console.log('hello world');
      return 'hello world';
    }
  `;
  const result = removeConsoleLog(code);
  expect(result).toBe(`
    function helloWorld() {
      return 'hello world';
    }
  `);
});
```

## ç‰¹å®šã®ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹

`use strict`ã‚’è¿½åŠ ã™ã‚‹å ´åˆã€‚

```js
const addUseStrict = (code: string) => {
  const ast = parse(code);
  visit(ast, {
    visitProgram(path) {
      const { node } = path;
      const useStrictStatement = b.expressionStatement(b.literal("use strict"));
      node.body.unshift(useStrictStatement);
      return false;
    },
  });
  return print(ast).code;
}
```

ğŸ§ª ãƒ†ã‚¹ãƒˆ

```js
test("add use strict", () => {
  const code = `
    function helloWorld() {
      return 'hello world';
    }
  `;
  const result = addUseStrict(code);
  expect(result).toBe(`
    "use strict";
    function helloWorld() {
      return 'hello world';
    }
  `);
})
```

## å‹ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹

`hello`é–¢æ•°ã«å‹ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹å ´åˆã€‚

```ts
const addTypeAnnotation = (code: string) => {
  const ast = parse(code, {
    parser: TSParser,
  });
  visit(ast, {
    visitFunctionDeclaration(path) {
      const { node } = path;
      if (!(n.Identifier.check(node.id) && node.id.name === "hello")) return false;
      if(n.Identifier.check(node.params[0])) { node.params[0].typeAnnotation = b.tsTypeAnnotation(
          b.tsStringKeyword()
        );
      }
      node.returnType = b.tsTypeAnnotation(
        b.tsStringKeyword()
      );
      return false
    },
  });
  return print(ast).code;
}
```

ğŸ§ª ãƒ†ã‚¹ãƒˆ

```js
test("add type annotation", () => {
  const code = `
    function hello(name) {
      return 'hello ' + name;
    }
  `;
  const result = addTypeAnnotation(code);
  expect(result).toBe(`
    function hello(name: string): string {
      return 'hello ' + name;
    }
  `);
})
```

# ãŠã‚ã‚Šã«

Recastã®ç´¹ä»‹ã§ã—ãŸã€‚ã“ã‚Œã‚’ä½¿ã£ã¦ä¾¿åˆ©ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã‚‚ä½œã‚ŒãŸãªã¨æ€ã£ã¦ã„ã¾ã™ğŸ’ª
