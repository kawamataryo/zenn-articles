---
title: "Changesetsã¨GitHub Actionsã§CHANGELOGé§†å‹•ã®è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹ç’°å¢ƒã‚’ä½œã‚‹"
emoji: "ğŸŒŠ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["changesets", "githubactions"]
published: false
---

å€‹äººçš„ã«æº€è¶³ã™ã‚‹Chromeæ‹¡å¼µè‡ªå‹•ãƒªãƒªãƒ¼ã‚¹ç’°å¢ƒãŒçµ„ã‚ãŸã®ã§ç´¹ä»‹ã§ã™ã€‚

# ã‚„ã‚ŠãŸã‹ã£ãŸã“ã¨

- æ‰‹å‹•ãƒ“ãƒ«ãƒ‰ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã€ã‚¹ãƒˆã‚¢ã¸ã®æ‰‹å‹•ç™»éŒ²ãŒé¢å€’ãªã®ã§è‡ªå‹•åŒ–ã—ãŸã„
- ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã—ãŸã‚‰è‡ªå‹•ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã—ã¦ã‚¹ãƒˆã‚¢ã«ç™»éŒ²ã—ã¦ã»ã—ã„
- **ã§ã‚‚releaseãƒ–ãƒ©ãƒ³ãƒã¯ä½œã‚ŠãŸããªã„**ã€‚mainãƒ–ãƒ©ãƒ³ãƒã®ã¿ã§é–‹ç™ºã—ãŸã„
- **æ™‚ã«ã¯ãƒªãƒªãƒ¼ã‚¹é–¢ä¿‚ãªãç›´æ¥mainãƒ–ãƒ©ãƒ³ãƒã«commit**ã—ãŸã„
- commit messageã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã¯åˆ†é›¢ã—ãŸã„

ã¨è¦æœ›å¤šã‚ãªæ€ æƒ°ãªãƒªãƒªãƒ¼ã‚¹ç’°å¢ƒã‚’æ±‚ã‚ã¦ã„ãŸã®ã§ã™ãŒã€Changesetsã¨GitHub Actionsã§ã„ã„æ„Ÿã˜ã«å®Ÿç¾ã§ãã¾ã—ãŸã€‚

# Changesetsã¨ã¯ï¼Ÿ

# çµ„ã‚“ã GitHub Actions

æœ€çµ‚çš„ãªGitHub Actionsã§ã™ã€‚å®Ÿéš›ã®å®Ÿè¡Œçµæœã¯ã“ã¡ã‚‰ã§ç¢ºèªã§ãã¾ã™ã€‚
https://github.com/kawamataryo/sky-follower-bridge/actions

```yml:.github/workflows/publish.yml
name: "Publish to Chrome Web Store"
on:
  push:
    branches:
      - main

jobs:
  # ãƒªãƒªãƒ¼ã‚¹åˆ¤å®šJob
  check-release-requirement:
    runs-on: ubuntu-latest
    steps:
      # ãƒ“ãƒ«ãƒ‰ç’°å¢ƒæ§‹ç¯‰
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          check-latest: true
      - name: Cache npm dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - name: Install dependencies
        run: npm ci

      # ãƒªãƒªãƒ¼ã‚¹åˆ¤å®š
      - name: Check if release is required
        run: ls .changeset/*.md > /dev/null 2>&1 && echo "result=release-required" >> $GITHUB_OUTPUT || echo "result=no-release-required" >> $GITHUB_OUTPUT
        id: check_release
        continue-on-error: true

    outputs:
      release: ${{ steps.check_release.outputs.result }}

  # ãƒªãƒªãƒ¼ã‚¹Job
  build-and-publish:
    needs: check-release-requirement
    # ãƒªãƒªãƒ¼ã‚¹ãŒå¿…è¦ãªå ´åˆã®ã¿å®Ÿè¡Œ
    if: needs.check-release-requirement.outputs.release == 'release-required'
    runs-on: ubuntu-latest
    steps:
      # ãƒ“ãƒ«ãƒ‰ç’°å¢ƒæ§‹ç¯‰
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          check-latest: true
      - name: Cache npm dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - name: Install dependencies
        run: npm ci

      # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°
      - name: Update version
        run: npx changeset version

      - name: Tag version
        run: npx changeset tag

      # ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°
      - name: Build the extension
        run: npm run build

      - name: Package the extension into a zip artifact
        run: npm run package

      # Chrome Web Storeã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Publish to Chrome Web Store
        uses: PlasmoHQ/bpp@v3
        with:
          keys: ${{ secrets.PUBLISH_KEYS }}
          artifact: build/chrome-mv3-prod.zip

      # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ã‚³ãƒŸãƒƒãƒˆ
      - name: Commit & Push changes
        uses: actions-js/push@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          message: "ğŸ”– bump version"
          tags: true
```

å‡¦ç†å†…å®¹ã‚’ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å›³ã§è¡¨ã™ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```mermaid
graph TB
subgraph èµ·å‹•æ¡
  A(mainãƒ–ãƒ©ãƒ³ãƒã¸ã®push)
end
subgraph check-release-requirement Job
  A --> B{changesetsä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰<br/>ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ã®å¿…è¦æ€§ã‚’åˆ¤å®š}
  B -->|ä¸è¦| C(ä½•ã‚‚ã›ãšæ­£å¸¸çµ‚äº†)
end
subgraph build-and-publish Job
  B -->|å¿…è¦| D(ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ»CHANGELOGã‚’æ›´æ–°)
  D --> E(Extensionã‚’ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°)
  E --> F(Chrome Web Storeã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰)
  F --> G(å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ã‚¿ã‚°ä»˜ã‘)
  G --> H(End)
end
```

# å·¥å¤«ã—ãŸã¨ã“ã‚

ãƒã‚¤ãƒ³ãƒˆã¯ãƒˆãƒªã‚¬ãƒ¼ã‚’mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã¨ã„ã†ç·©ã„æ¡ä»¶ã«ã—ã¤ã¤ã€**ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ã®å¿…è¦æ€§ã‚’changesetsã§åˆ¤å®šã—ã¦ãƒªãƒªãƒ¼ã‚¹ã‚’å®Ÿè¡Œ**ã—ã¦ã„ã‚‹ã¨ã“ã‚ã§ã™ã€‚

ã“ã†ã™ã‚‹ã“ã¨ã§ã€Releaseãƒ–ãƒ©ãƒ³ãƒã‚’ä½œã‚‰ãšã«mainãƒ–ãƒ©ãƒ³ãƒã®ã¿ã®é–‹ç™ºã§ã‚‚ã€å¿…è¦ãªæ™‚ã®ã¿ãƒªãƒªãƒ¼ã‚¹ã§ãã¾ã™ã€‚

ã¾ãŸã€ã‚‚ã—ãƒªãƒªãƒ¼ã‚¹ã®å¿…è¦ãŒãªã„å ´åˆã¯ã€å®Ÿè¡Œè‡ªä½“ã‚’å¤±æ•—ã¨ã—ã¦ã‚‚è‰¯ã‹ã£ãŸã®ã§ã™ãŒã€mainãƒ–ãƒ©ãƒ³ãƒã®CIãŒè½ã¡ã¦ã„ã‚‹ã®ã¯é•å’Œæ„ŸãŒã‚ã‚‹ã®ã§`continue-on-error: true`ã§ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã—ãŸä¸Šã§æ¬¡ã®Jobã§å®Ÿè¡Œåˆ¤å®šã—ã¦ã„ã¾ã™ã€‚

```yml:.github/workflows/publish.yml
jobs:
  # ãƒªãƒªãƒ¼ã‚¹åˆ¤å®šJob
  check-release-requirement:
      # ...
      # ãƒªãƒªãƒ¼ã‚¹åˆ¤å®š
      - name: Check if release is required
        run: ls .changeset/*.md > /dev/null 2>&1 && echo "result=release-required" >> $GITHUB_OUTPUT || echo "result=no-release-required" >> $GITHUB_OUTPUT
        id: check_release
        continue-on-error: true

    outputs:
      release: ${{ steps.check_release.outputs.result }} # ã“ã®å€¤ãŒæ¬¡ã®Jobã«æ¸¡ã•ã‚Œã‚‹

  # ãƒªãƒªãƒ¼ã‚¹Job
  build-and-publish:
    needs: check-release-requirement
    # ãƒªãƒªãƒ¼ã‚¹ãŒå¿…è¦ãªå ´åˆã®ã¿å®Ÿè¡Œ
    if: needs.check-release-requirement.outputs.release == 'release-required'
    # ...
```
