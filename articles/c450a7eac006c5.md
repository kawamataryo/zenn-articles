---
title: "GitHub Actions ã§ Firebase Functions ã®CDç’°å¢ƒã‚’ä½œã‚‹"
emoji: "ğŸšš"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["firebase", "gcp", "githubActions"]
published: true
---

Cloud Functions for Firebaseï¼ˆä»¥ä¸‹ Functionsï¼‰ã§ä½œã£ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ GitHub Actions ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

ã“ã¡ã‚‰ã®è¨˜äº‹ã®ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ãƒªãƒã‚¸ãƒˆãƒªã§ç¢ºèªã§ãã¾ã™ã€‚

https://github.com/kawamataryo/firebase-cd-sample

# GCP å´ã®è¨­å®š

Functions ã‚’ GitHub Actions ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã«ã¯ã€GCP ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå¿…è¦ã§ã™ã€‚
æœ€åˆã«ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆã¨æ¨©é™ä»˜ä¸ã‚’è¡Œã„ã¾ã™ã€‚

GCP ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å¯¾è±¡ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ãŸä¸Šã§`IAM ã¨ç®¡ç†`ã‚’é–‹ãã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

![](/images/c450a7eac006c5/2023-03-01-17-39-04.png)

ãƒ­ãƒ¼ãƒ«ã«ã¯ `Firebase ã®ç®¡ç†è€…` ã‚’è¨­å®šã—ã¾ã™ã€‚

![](/images/c450a7eac006c5/2023-03-01-17-40-38.png)

:::message
ã‚‚ã£ã¨ç´°ã‹ãæ¨©é™ã‚’ç®¡ç†ã—ãŸã„å ´åˆã¯ã€[GitHub Action for Firebase ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://github.com/marketplace/actions/github-action-for-firebase#environment-variables)ã‚’å‚è€ƒã«å¿…è¦ãªæ¨©é™ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚
:::

ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆãŒå®Œäº†ã—ãŸã‚‰ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚­ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚

![](/images/c450a7eac006c5/2023-03-01-17-41-38.png)

![](/images/c450a7eac006c5/2023-03-01-17-42-36.png)

JSON ã‚¿ã‚¤ãƒ—ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚

# Repository å´ã®è¨­å®š

Repository ã® Settings ã‹ã‚‰ GitHub Actions ç”¨ã® Secrets ã‚’ä½œæˆã—ã¾ã™ã€‚
`GCP_SA_KEY` ã¨ã„ã†åå‰ã§å…ˆã»ã©ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸ JSON ã®ä¸­èº«ã‚’è¨­å®šã—ã¾ã™ã€‚

![](/images/c450a7eac006c5/2023-03-01-17-46-46.png)

ã“ã‚Œã§ GitHub Actions ã§ Functions ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚

# GitHub Actions ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

ãƒªãƒã‚¸ãƒˆãƒªã®`.github/workflows`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«`deploy.yml`ã¨ã„ã†åå‰ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```yml
name: Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3
      - name: Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: "npm"
          cache-dependency-path: functions/package-lock.json
      - name: Install dependencies
        run: npm install -C functions
      - name: Deploy to Firebase
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only functions
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
```

[github-action-for-firebase](https://github.com/marketplace/actions/github-action-for-firebase#environment-variables)ã¨ã„ã† Action ã‚’ä½¿ã£ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã„ã¾ã™ã€‚

https://github.com/w9jds/firebase-action

`args` ã®éƒ¨åˆ†ã¯ä»»æ„ã®ã‚³ãƒãƒ³ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚ã“ã®ä¾‹ã ã¨ã€`functions`ã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã„ã¾ã™ã€‚

ã‚ã¨ã¯ã€`main`ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ã¨ GitHub Actions ãŒå®Ÿè¡Œã•ã‚Œã€Functions ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ ğŸš€

![](/images/c450a7eac006c5/2023-03-01-18-00-33.png)

# ãŠã¾ã‘ï¼‰Functions ã®ç’°å¢ƒå¤‰æ•°ã‚‚ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å ´åˆ

Functions ã®ä¸­ã§ä½¿ã£ã¦ã„ã‚‹ç’°å¢ƒå¤‰æ•°ã‚‚ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«è¨­å®šã—ãŸã„å ´åˆã¯ã€`CONFIG_VALUES`ã‚’è¨­å®šã—ã¾ã™ã€‚

ã¾ãšã€GitHub Actions ç”¨ã® Secrets ã« `CONFIG_VALUES` ã¨ã„ã†åå‰ã§ä½œæˆã—ã¾ã™ã€‚

![](/images/c450a7eac006c5/2023-03-01-17-54-15.png)

æ¬¡ã«å…ˆã»ã©`deploy.yml`ã‚’ä¿®æ­£ã—ã¾ã™ã€‚æœ€å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã® env ã«ã€`CONFIG_VALUES`ã‚’è¿½åŠ ã™ã‚Œã° OK ã§ã™ã€‚

```diff yml:deploy.yml
 name: Deploy

 on:
   push:
     branches:
       - main

 jobs:
   deploy:
     name: Deploy
     runs-on: ubuntu-latest
     steps:
       - name: Checkout Repo
         uses: actions/checkout@v3
       - name: Setup node
         uses: actions/setup-node@v3
         with:
           node-version: 16
           cache: "npm"
           cache-dependency-path: functions/package-lock.json
       - name: Install dependencies
         run: npm install -C functions
       - name: Deploy to Firebase
         uses: w9jds/firebase-action@master
         with:
           args: deploy --only functions
         env:
           GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
+          CONFIG_VALUES: ${{ secrets.CONFIG_VALUES }}
```

ã“ã‚Œã§ç’°å¢ƒå¤‰æ•°ã‚‚ä¸€ç·’ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚

## ãŠã‚ã‚Šã«

ç°¡å˜ã§ã™ãŒã€GitHub Actions ã§ Functions ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–¹æ³•ã§ã—ãŸã€‚
ä»Šã¯ãªã‚“ã§ã‚‚ GitHub Actions ã§ã‚µã‚¯ãƒƒã¨ä½œã‚Œã¦æœ€é«˜ã§ã™ã­ã€‚
