---
title: "LangChainã‚’ä½¿ã£ã¦WEBã‚µã‚¤ãƒˆã‚’è¦ç´„ã™ã‚‹æ™‚ã®ãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹"
emoji: "ğŸ¦œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["langchain", "openai", "typescript"]
published: false
---

LangChainã‚’ä½¿ã£ã¦Webãƒšãƒ¼ã‚¸ã‚’è¦ç´„ã—ã‚ˆã†ã¨æ€ã£ãŸã‚‰è‰²ã€…è©°ã¾ã£ãŸã®ã§å‚™å¿˜éŒ²ã¨ã—ã¦ã¾ã¨ã‚ã¾ã™ã€‚

ğŸ“ å‹•ä½œç¢ºèªç’°å¢ƒ
- M1 macOS 12.6
- Node.js 18
- [LangChain 0.0.95](https://www.npmjs.com/package/langchain/v/0.0.95)

# ğŸš€ å®Œæˆã‚³ãƒ¼ãƒ‰

æœ€åˆã«å®Œæˆã‚³ãƒ¼ãƒ‰ã‚’ã€‚URLã‚’å¼•æ•°ã§æ¸¡ã™ã¨ãã®ãƒšãƒ¼ã‚¸ã®è¦ç´„ã‚’å‡ºåŠ›ã—ã¦ãã‚Œã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚³ãƒ¼ãƒ‰ä¾‹ã§ã™ã€‚

```ts
import { OpenAI } from "langchain/llms/openai";
import { loadSummarizationChain, LLMChain } from "langchain/chains";
import { PuppeteerWebBaseLoader } from "langchain/document_loaders/web/puppeteer";
import { PromptTemplate } from "langchain/prompts";

const summarization = async (url: string) => {
  // Webãƒšãƒ¼ã‚¸ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
  const loader = new PuppeteerWebBaseLoader(url, {
    launchOptions: {
      headless: "new",
      args: ["--user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3"],
    },
    async evaluate(page) {
      const result = await page.evaluate(() => {
        // ä¸è¦ãªè¦ç´ ã‚’å‰Šé™¤
        const scripts = document.body.querySelectorAll("script");
        const noscript = document.body.querySelectorAll("noscript");
        const styles = document.body.querySelectorAll("style");
        const scriptAndStyle = [...scripts,  ...noscript, ...styles,];
        scriptAndStyle.forEach((e) => e.remove());

        // æœ¬æ–‡ã‚’åé›†
        const mainElement = document.querySelector('main');
        return  mainElement ? mainElement.innerText : document.body.innerText;
      })
      return result;
    },
  });
  const docs = await loader.loadAndSplit();

  // ãƒ¢ãƒ‡ãƒ«ã®æŒ‡å®š OpenAI gpt-3.5-turbo
  const model = new OpenAI({ openAIApiKey: process.env.OPENAI_API_KEY, temperature: 0, modelName: "gpt-3.5-turbo" });

  // promptã®ä½œæˆ
  const prompt = new PromptTemplate({
    template: `ä»¥ä¸‹ã®æ–‡ç« ã‚’è¦ç´„ã—ã¦ãã ã•ã„ã€‚\n\n---\n{text}\n---\n\nè¦ç´„:`,
    inputVariables: ["text"],
  });

  // è¦ç´„ã®å®Ÿè¡Œ
  const chain = loadSummarizationChain(model, {
    combineMapPrompt: prompt,
    combinePrompt: prompt,
    type: "map_reduce",
  });
  const result = await chain.call({
    input_documents: docs
  });

  console.log(`\n\nğŸ”— link:\n${url}\n\nğŸ“ summary:\n${result.text}`);
}

(async () => {
  const targetUrl = process.argv[2]
  await summarization(targetUrl);
})()
```

CLIä¸Šã§è¦ç´„ã—ãŸã„URLã‚’å¼•æ•°ã«æ¸¡ã—ã¦å®Ÿè¡Œã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¦ç´„çµæœã‚’å‡ºåŠ›ã—ã¦ãã‚Œã¾ã™ã€‚

```sh
$ ts-node index.ts https://note.com/ryo_kawamata/n/n4fc0fa900314

ğŸ”— link:
https://note.com/ryo_kawamata/n/n4fc0fa900314

ğŸ“ summary:
æ¶ˆé˜²å£«ã‹ã‚‰æœªçµŒé¨“ã§ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã«è»¢è·ã—ã€1å¹´é–“åƒã„ãŸå¾Œã«é€€è·ã—ãŸäººç‰©ãŒã€è‡ªèº«ã®çµŒæ­´ã‚„è»¢è·ã®ç†ç”±ã€ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦ã®çµŒé¨“ã«ã¤ã„ã¦èªã£ã¦ã„ã‚‹ã€‚Javaã‚„Spring Bootã§ã®å®Ÿå‹™çµŒé¨“ã‚’é€šã˜ã¦ã€è‰¯ã„è¨­è¨ˆã‚„å‹ã®åˆ©ç‚¹ã€ãƒ†ã‚¹ãƒˆã®é‡è¦æ€§ãªã©ã‚’å­¦ã³ã€é™çš„å‹ä»˜ã‘è¨€èªãŒå¥½ãã«ãªã£ãŸã€‚é€€è·ç†ç”±ã¯å®¶åº­ã®äº‹æƒ…ã§ã€ãƒªãƒ¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ãŒã§ãã‚‹ç’°å¢ƒã‚’æ±‚ã‚ãŸã€‚è»¢è·å…ˆã¯ã‚¯ãƒ©ã‚¦ãƒ‰è«‹æ±‚ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹ã®ä¼šç¤¾ã§ã€Railsã¨Vue.jsã‚’å‹‰å¼·ä¸­ã€‚ä»Šå¾Œã¯æˆé•·ã—ã€äº‹æ¥­ã«å¤§ããªå½±éŸ¿ã‚’ä¸ãˆã‚‹æˆæœã‚’å‡ºã—ãŸã„ã¨è€ƒãˆã¦ã„ã‚‹ã€‚
```

ã‚³ãƒ¼ãƒ‰ã¯ã™ã¹ã¦ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã§å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚

https://github.com/kawamataryo/sandbox-summary-by-langhchain

# ğŸ› ï¸ ãƒã‚¤ãƒ³ãƒˆ

## PuppeteerWebBaseLoaderã§è¦ç´„ãƒšãƒ¼ã‚¸ã®ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã®ã¿ã‚’å–å¾—ã™ã‚‹
SPAã‚‚è€ƒæ…®ã—ãŸWebãƒšãƒ¼ã‚¸ã®ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã€PuppeteerWebBaseLoaderã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚ã“ã“ã§ã®ãƒã‚¤ãƒ³ãƒˆã¯ã€`evaluate`ã§å–å¾—ã—ãŸã„ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã®ã¿ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã™ã€‚

PuppeteerWebBaseLoaderã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ãƒšãƒ¼ã‚¸æƒ…å ±ã®å–å¾—ã«`document.body.innerHTML`ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

https://github.com/hwchase17/langchainjs/blob/8ddf206998f323ae2785371a6d0fdfabdf5a7ba2/langchain/src/document_loaders/web/puppeteer.ts#L61-L63

`innerHTML`ã§ã®ãƒ†ã‚­ã‚¹ãƒˆå–å¾—ã ã¨ã€è¦ç´„ã«ä¸è¦ãªHTMLã®ã‚¿ã‚°ã‚„CSSã€scriptã‚‚å«ã¾ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚ã“ã‚ŒãŒãƒˆãƒ¼ã‚¯ãƒ³ã®åˆ©ç”¨é‡ã‚’ãƒ ãƒ€ã«å¢—ã‚„ã—ã¦ã—ã¾ã†åŸå› ã«ãªã‚Šã¾ã™ã€‚

`evaluate`ã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ä¸Šæ›¸ãã€å¿…è¦ãªè¦ç´ ã®ã¿`innerText`ã§æœ¬æ–‡ã‚’å–å¾—ã™ã‚‹ã“ã¨ã§ã€ä¸è¦ãªæƒ…å ±ã«ã‚ˆã£ã¦è¦ç´„çµæœãŒæ­ªã‚€ã“ã¨ã‚’é˜²ãã€APIã®ãƒˆãƒ¼ã‚¯ãƒ³åˆ©ç”¨æ•°ã‚‚ç¯€ç´„ã§ãã¾ã™ã€‚

```ts
    async evaluate(page) {
      const result = await page.evaluate(() => {
        // ä¸è¦ãªè¦ç´ ã‚’å‰Šé™¤
        const scripts = document.body.querySelectorAll("script");
        const noscript = document.body.querySelectorAll("noscript");
        const styles = document.body.querySelectorAll("style");
        const scriptAndStyle = [...scripts,  ...noscript, ...styles,];
        scriptAndStyle.forEach((e) => e.remove());

        // æœ¬æ–‡ã‚’åé›†
        const mainElement = document.querySelector('main');
        return  mainElement ? mainElement.innerText : document.body.innerText;
      })
      return result;
    },
```

:::message
ã‚‚ã—ã€è¦ç´„ã‚’å®Ÿè¡Œã™ã‚‹Webãƒšãƒ¼ã‚¸ãŒé™å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãã‚Œã«åˆã‚ã›ã¦evaluateã®å‡¦ç†ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šæ­£ç¢ºãªè¦ç´„çµæœã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
:::

## LoadAndSplitã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’åˆ†å‰²

å®Œæˆã‚³ãƒ¼ãƒ‰ã§ã¯PuppeteerWebBaseLoaderã§å–å¾—ã—ãŸãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’OpenAIã®APIã«æ¸¡ã™éš›ã«ã€`loadAndSplit`ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚

https://github.com/kawamataryo/sandbox-summary-by-langhchain/blob/main/index.ts#L29

PuppeteerWebBaseLoaderã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯ã€`Load`ã®æ–¹ã§è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã®ã§é–“é•ãˆãŸäººãŒã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼ˆç§ğŸ˜‡ï¼‰ã€‚ã—ã‹ã—`loadAndSplit`ã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’åˆ†å‰²ã—ãªã‘ã‚Œã°ã€Summarization Chain ã‚’åˆ©ç”¨ã™ã‚‹æ—¨å‘³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

`load` ã§docsã‚’ç”Ÿæˆã™ã‚‹ã¨ã€ãƒšãƒ¼ã‚¸æƒ…å ±ãŒä»¥ä¸‹ã®ã‚ˆã†ã«å˜ä¸€ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æ‰±ã‚ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚

```
[
  { Document: { "pageContent: 'æ¶ˆé˜²å£«ã‹ã‚‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¸ã€ãã—ã¦é€€è·ã—ã¦\n...." }, metadata: { ... } }
]
```

ã—ã‹ã—ã€`loadSplit` ã§docsã‚’ç”Ÿæˆã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’åˆ†å‰²ã—ã¦ãã‚Œã¾ã™ã€‚

```
[
  { Document: { "pageContent: 'æ¶ˆé˜²å£«ã‹ã‚‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¸ã€ãã—ã¦é€€è·\n...." }, metadata: { ... } }
  { Document: { "pageContent: 'å‰è·ã§ã¯...'}, metadata: { ... } }
  { Document: { "pageContent: 'ç­‹è‚‰KTã§LTã—ã¦...'}, metadata: { ... } }
  ....
]
```

Summarization Chainã¯ã€åˆ†å‰²ã•ã‚ŒãŸdocumentã‚’è¦ç´„ã™ã‚‹Chainã§ã™ã€‚ã¨ãã«ãƒšãƒ¼ã‚¸ã®æ–‡ç« é‡ãŒå¤šã„å ´åˆã¯ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’åˆ†å‰²ã—ãªã„ã¨ã€ãƒ¢ãƒ‡ãƒ«ã®æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’è¶…éã—ã¦ã—ã¾ã„å®Ÿè¡Œæ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚

loadAndSplitã®å¼•æ•°ã«splitterã‚’æŒ‡å®šã—ãªã„å ´åˆã€documentã®åˆ†å‰²ã«ã¯[RecursiveCharacterTextSplitter](https://js.langchain.com/docs/modules/indexes/text_splitters/examples/recursive_character)ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ä»–ã®splitterã‚‚æŒ‡å®šã§ãã¾ã™ãŒã€åŸºæœ¬ã¯RecursiveCharacterTextSplitterã§ã‚ˆã„ã¨æ€ã„ã¾ã™ã€‚

https://js.langchain.com/docs/modules/indexes/text_splitters/

## Promptã®ä¸Šæ›¸ã

Summarization Chainã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®Promptã‚’ä¸Šæ›¸ãã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

## Mapã§è¦ç´„çµæœã‚’æ•´å½¢

https://docs.langchain.com/docs/components/chains/index_related_chains
