---
title: "[Minecraft × ChatGPT] マイクラで作りたいものを伝えると魔法みたいに実現してくれるコマンドを作る"
emoji: "💫"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["minecraft", "openai", "python"]
published: true
---

息子と一緒に遊びたいなと、Minecraft と ChatGPT を繋げて、やりたいことを日本語で伝えるといい感じに実現してくれるコマンドを作りました

# 🪄 作ったもの

`/py magic` に続けてやりたいことを伝えると、いい感じに実現してくれます。

**家をつくる例**
`/py magic 10マス先に豪華な家を作って。窓は広めで。`
![](https://i.gyazo.com/d83ec1fd5ba5a4e25e458767882df252.gif =600x)

**水流エレベーターをつくる例**
`/py magic 水流エレベーターを作って。周りは石ブロックで。`
![](https://i.gyazo.com/2aa4c91a4d57a839171e5408631baeb2.gif =600x)

# 🛠️ 実装

事前に Minecraft で Python を実行できる環境を整えます。

https://files.minecraftforge.net/net/minecraftforge/forge/
https://github.com/arpruss/raspberryjammod

`mcpi` で Minecraft に接続できれば OK です。

次に必要なモジュールをインストールします。

```
pip install mistletoe openai mcpi
```

そして、`mcpi`ディレクトリに以下コードで `magic.py` を作り保存します。

```python:magic.py
import openai
import sys
from mcpi import minecraft
from mistletoe import Document, block_token
from mistletoe.block_token import CodeFence

mc = minecraft.Minecraft.create()

# Chat Completion API から返ってくるテキストからコード部分を抽出する
def get_code_blocks(text: str):
    doc = Document(text)

    code_blocks = []
    for token in doc.children:
        if isinstance(token, CodeFence):
            code_blocks.append(token.children[0].content)

    return "\n\n".join(code_blocks)

# Chat Completion API でコード生成
def think_code(prompt: str):
    system_prompt = f"""
Please write Python code to implement the instructions below in Minecraft.
In addition, please observe the following rules when outputting the code.

- You must use the `mcpi` library to connect to Minecraft.
- Your Python version must be 3.x.
- Your Minecraft version is 1.12.2.
- No comments in the code.
- The output code must be a single Python file.
- When building, build 20 squares ahead in the direction the player is looking.
- The output code should be in a form that can be executed by exec

# Instructions:
{prompt}

"""
    openai.api_key = "YOUR API KEY"
    completion = openai.ChatCompletion.create(model="gpt-3.5-turbo", messages=[
      {"role": "system", "content": "You are a talented Python programmer and Minecraft builder.You can use mcpi to control Minecraft"},
      {"role": "user", "content": system_prompt}
    ])

    return completion.choices[0].message.content

def main():
    # 引数からpromptを取得
    prompt = sys.argv[1]
    mc.postToChat(f"Prompt: {prompt}")

    # chat completion APIでコード生成
    generated_text = think_code(prompt)
    # APIの出力結果からコード部分をテキストで抽出
    code = get_code_blocks(generated_text)

    try:
        # evalする
        exec(code)
        mc.postToChat("Completed")
    except Exception as e:
        mc.postToChat(f"Error: {e}")


main()
```

引数で受け取った prompt を Chat Completion API に渡して、その出力結果からコードを抽出して exec で実行しています。

:::message
どんなコードが返ってくるのか分からないのに、exec で実行するというヤバめな実装なので、実行は自己責任でお願いします 🙏
:::

あとは、Minecraft に入り `/py magic` でやりたことを伝えるだけです。

# おわりに

まだ Prompt の詰めが甘いので、なかなかうまく建物を作ってくれないことが多いですが、息子が喜んでくれたのでヨシ！！

https://twitter.com/KawamataRyo/status/1632333351578390528
