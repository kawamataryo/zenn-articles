---
title: "The Super Tiny Compiler ã§ã¯ã˜ã‚ã‚‹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©å…¥é–€"
emoji: "â¤ï¸â€ğŸ”¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["compiler", "typescript", "deno"]
published: false
---

# tl;dr

[The Super Tiny Compiler](https://github.com/jamiebuilds/the-super-tiny-compiler) ã¯ã‚ãšã‹ 200 è¡Œã®ã‚³ãƒ¼ãƒ‰ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®ä»•çµ„ã¿ã‚’å­¦ã¹ã‚‹ã®ã§æœ€é«˜ï¼

# The Super Tiny Compiler ã¨ã¯ï¼Ÿ

[The Super Tiny Compiler](https://github.com/jamiebuilds/the-super-tiny-compiler) ã¯ã€200 è¡Œã® JavaScript ã§æ›¸ã‹ã‚ŒãŸã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã§ã™ã€‚

https://github.com/jamiebuilds/the-super-tiny-compiler

Super Tiny ã®è¨€è‘‰é€šã‚Šæ©Ÿèƒ½ã¯ã¨ã¦ã‚‚é™å®šã•ã‚Œã¦ã„ã¦ã€LISP ã½ã„é–¢æ•°å‘¼ã³å‡ºã—ã‚’ C è¨€èªã®ã‚ˆã†ãªé–¢æ•°å‘¼ã³å‡ºã—ã«å¤‰æ›ã™ã‚‹ã ã‘ã§ã™ã€‚

```lisp
;ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«å‰
(add 2 (subtract 4 2))
```

```c
//ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«å¾Œ
add(2, subtract(2, 4));
```

ãŸã ã€å†…éƒ¨å®Ÿè£…çš„ã«ã¯ `å¤‰æ›å…ƒã‚³ãƒ¼ãƒ‰` âœ `Tokenize(å­—å¥è§£æ)` âœ `Parse(æ§‹æ–‡è§£æ)` âœ `Transformationï¼ˆå¤‰æ›ï¼‰` âœ ` Generationï¼ˆã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼‰` âœ `å¤‰æ›å¾Œã‚³ãƒ¼ãƒ‰` ã¨ä¸€èˆ¬çš„ãªã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®å‡¦ç†ã®æµã‚Œã‚’è¸è¥²ã—ã¦ã„ã¾ã™ã€‚

![](/images/302577a69c06b7/2022-10-02-19-53-39.png)

å¿ƒåº•ä¸å¯§ã«ã‚³ãƒ¡ãƒ³ãƒˆãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã‚Œã‚’å†™çµŒã™ã‚‹ã ã‘ã§ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®é›°å›²æ°—ãŒç†è§£ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚

https://github.com/jamiebuilds/the-super-tiny-compiler/blob/master/the-super-tiny-compiler.js#L363-L540

:::message
ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã¨ã„ã†åå‰ã§ã™ãŒã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯ã€lisp ã½ã„é«˜æ°´æº–è¨€èªã‚’ C ã½ã„é«˜æ°´æº–è¨€èªã«å¤‰æ›ã™ã‚‹ã®ã§ã€ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ©ã¨ã„ã†æ–¹ãŒæ­£ç¢ºã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã§ã™ãŒã€å…ƒã‚³ãƒ¼ãƒ‰ãŒã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãªã®ã§ã€æœ¬è¨˜äº‹ã§ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã§çµ±ä¸€ã—ã¾ã™ã€‚
ã‚ã¨ã€ã€Œæ„å‘³è§£æã‚„æœ€é©åŒ–ãŒãªã„ãï¼ã€ã¨æ€ã†æ–¹ã‚‚ã„ã‚‹ã‹ã‚‚ã§ã™ãŒã€ãã‚Œã¯æµçŸ³ã« 200 è¡Œãªã®ã§ã”ã‚ã‚“ã‚„ã§ã€‚ã€‚
:::

:::message
ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã¯ã€åŒåƒšã® [@tktcorporation](https://twitter.com/tktcorporation) ã¨ [@yogo_yuichi](https://twitter.com/yogo_yuichi) ã«æ•™ãˆã¦ã‚‚ã‚‰ã„ã¾ã—ãŸã€‚æ„Ÿè¬ ğŸ™
:::

# æ©Ÿèƒ½ã”ã¨ã®æŒ¯ã‚Šè¿”ã‚Š

ä»Šå›ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®å‹‰å¼·ãŒã¦ã‚‰ Deno ã§å†å®Ÿè£…ã—ã¦ã¿ã¾ã—ãŸã€‚ãã®ã‚³ãƒ¼ãƒ‰ã¨ã¨ã‚‚ã«å„æ©Ÿèƒ½å®Ÿè£…ã®æŒ¯ã‚Šè¿”ã‚Šã‚’è¨˜è¼‰ã—ã¾ã™ã€‚

ç§ã®å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ãƒªãƒã‚¸ãƒˆãƒªã§ã™ã€‚å…ƒãƒªãƒã‚¸ãƒˆãƒªã§ã¯ã€ã™ã¹ã¦ 1 ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã‚‰ã‚Œã¦ã„ã¾ã™ãŒã€åˆ†ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã«æ©Ÿèƒ½ã”ã¨ã«ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã—ã¦ã€ãã‚Œãã‚Œã« Unit Test ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚

https://github.com/kawamataryo/the-super-tiny-compiler-deno

## Tokenizeï¼ˆå­—å¥è§£æï¼‰

![](/images/302577a69c06b7/2022-10-02-19-53-58.png)

Tokenize ã§ã¯ã€ã‚³ãƒ¼ãƒ‰ã®æ–‡å­—åˆ—ã‚’ã€`Token` ã¨ã„ã†ç¨®åˆ¥ã”ã¨ã«ãƒ©ãƒ™ãƒ«ä»˜ã‘ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—ã«å¤‰æ›ã—ã¾ã™ã€‚ã“ã“ã§ã€ä¸è¦ãªç©ºç™½ãªã©ã¯å‰Šé™¤ã•ã‚Œã¾ã™ã€‚

```js
const token = [
  { type: "paren", value: "(" },
  { type: "name", value: "add" },
  { type: "number", value: "2" },
  { type: "number", value: "4" },
  { type: "paren", value: ")" },
];
```

ä»•çµ„ã¿çš„ã«ã¯ã€while ãƒ«ãƒ¼ãƒ—ã§ã‚³ãƒ¼ãƒ‰ã®æ–‡å­—åˆ—ã‚’ä¸€æ–‡å­—ãšã¤è§£æã—ã¦ã€ç¨®åˆ¥ã”ã¨ã«ãƒ©ãƒ™ãƒ«ã¨å€¤ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã—ã¦ã„ãå½¢ã§ã™ã€‚

The Super Tiny Compiler ã§ã¯ã€ä»¥ä¸‹ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œã‚Šã¾ã™ã€‚

| token å | å€¤                              |
| -------- | ------------------------------- |
| `number` | `1`, `22` ãªã©ã®æ•°å€¤            |
| `string` | `"taro"`, `"èŠ±å­"` ãªã©ã®æ–‡å­—åˆ— |
| `paren`  | `(`, `)`ãªã©ã®ã‚«ãƒƒã‚³            |
| `name`   | `add` `sum` ãªã©ã®é–¢æ•°å        |

https://github.com/kawamataryo/the-super-tiny-compiler-deno/blob/main/src/modules/tokenizer.ts#L1-L75

## Parseï¼ˆæ§‹æ–‡è§£æï¼‰

![](/images/302577a69c06b7/2022-10-02-19-54-19.png)

Parse ã§ã¯ã€Token ã‚’ ASTï¼ˆæŠ½è±¡æ§‹æ–‡æœ¨ï¼‰ã«å¤‰æ›ã—ã¾ã™ã€‚AST ã¯ã€ã‚³ãƒ¼ãƒ‰ã®æ§‹æ–‡æ§‹é€ ï¼ˆæ„å‘³ã‚’ç†è§£ã™ã‚‹ãŸã‚ã«å¿…è¦ãªæ§‹é€ ï¼‰ã‚’æœ¨æ§‹é€ ã§è¡¨ã—ãŸã‚‚ã®ã§ã™ã€‚ã“ã“ã§ã€ã•ãã»ã©ã®`paren`ï¼ˆ`()`ï¼‰ãªã©ã€å–ã‚Šé™¤ã‹ã‚Œã¦ã€é–¢æ•°ã€å¼•æ•°ã€æ–‡ãªã©ã®ã¾ã¨ã¾ã‚Šã”ã¨ã«æ§‹é€ åŒ–ã•ã‚Œã¾ã™

```js
const ast = {
  type: "Program",
  body: [
    {
      type: "CallExpression",
      name: "add",
      params: [
        {
          type: "NumberLiteral",
          value: "2",
        },
        {
          type: "NumberLiteral",
          value: "4",
        },
      ],
    },
  ],
};
```

The Super Tiny Compiler ã§æŠ½å‡ºã™ã‚‹æ§‹æ–‡è§£æã®ã‚¿ã‚¤ãƒ—ã¯ä»¥ä¸‹ã§ã™ã€‚

| ã‚¿ã‚¤ãƒ—å         | å€¤                              |
| ---------------- | ------------------------------- |
| `Program`        | ã‚³ãƒ¼ãƒ‰å…¨ä½“                      |
| `NumberLiteral`  | `1`, `22` ãªã©ã®æ•°å€¤            |
| `StringLiteral`  | `"taro"`, `"èŠ±å­"` ãªã©ã®æ–‡å­—åˆ— |
| `CallExpression` | `add(2, 3)`ãªãŠã©ã®é–¢æ•°         |

https://github.com/kawamataryo/the-super-tiny-compiler-deno/blob/main/src/modules/parser.ts#L1-L67

## Transform (å¤‰æ›)

![](/images/302577a69c06b7/2022-10-02-19-51-17.png)

Transform ã§ã¯ AST ã‚’å‡ºåŠ›ã—ãŸã„æ§‹æ–‡æ§‹é€ ã® AST ã«å¤‰æ›ã—ã¾ã™ã€‚ã“ã“ã§ã¯ã€Visitor ã¨ã„ã† AST ã‚’å·¡å›ã™ã‚‹é–¢æ•°ã¨ã€ Transformer ã¨ã„ã† Visitor ã‚’ä½¿ã£ã¦å®Ÿéš›ã«å¤‰æ›ã™ã‚‹é–¢æ•°ã‚’ä½œæˆã—ã¾ã™ã€‚

### Visitor

### Transformer

## Code Generate

https://github.com/kawamataryo/the-super-tiny-compiler-deno/blob/main/src/modules/code_generator.ts#L1-L30

##
