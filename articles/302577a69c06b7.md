---
title: "The Super Tiny Compiler ã§ã¯ã˜ã‚ã‚‹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©å…¥é–€"
emoji: "â¤ï¸â€ğŸ”¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["compiler", "typescript", "deno"]
published: false
---

# The Super Tiny Compiler ã¨ã¯ï¼Ÿ

[The Super Tiny Compiler](https://github.com/jamiebuilds/the-super-tiny-compiler) ã¯ã€ã‚ãšã‹ **200 è¡Œã® JavaScript ã§æ›¸ã‹ã‚ŒãŸã‚³ãƒ³ãƒ‘ã‚¤ãƒ©**ã§ã™ã€‚

https://github.com/jamiebuilds/the-super-tiny-compiler

Super Tiny ã®è¨€è‘‰ã©ãŠã‚Šæ©Ÿèƒ½ã¯ã¨ã¦ã‚‚é™å®šã•ã‚Œã¦ã„ã¦ã€LISP ã½ã„é–¢æ•°å‘¼ã³å‡ºã—ã‚’ C è¨€èªã®ã‚ˆã†ãªé–¢æ•°å‘¼ã³å‡ºã—ã«å¤‰æ›ã™ã‚‹ã ã‘ã§ã™ã€‚

```lisp
;ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«å‰
(add 2 (subtract 4 2))
```

```c
//ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«å¾Œ
add(2, subtract(2, 4));
```

ãŸã ã€å†…éƒ¨å®Ÿè£…çš„ã«ã¯ `å¤‰æ›å…ƒã‚³ãƒ¼ãƒ‰` âœ `Tokenize(å­—å¥è§£æ)` âœ `Parse(æ§‹æ–‡è§£æ)` âœ `Transformï¼ˆå¤‰æ›ï¼‰` âœ ` Generateï¼ˆã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼‰` âœ `å¤‰æ›å¾Œã‚³ãƒ¼ãƒ‰` ã¨ä¸€èˆ¬çš„ãªã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®å‡¦ç†ã®æµã‚Œã‚’è¸è¥²ã—ã¦ã„ã¾ã™ã€‚

![](/images/302577a69c06b7/2022-10-02-19-58-15.png)

ã™ã¹ã¦ã®ã‚³ãƒ¼ãƒ‰ã«å¿ƒåº•ä¸å¯§ã«ã‚³ãƒ¡ãƒ³ãƒˆãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã‚Œã‚’å†™çµŒã™ã‚‹ã ã‘ã§ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®é›°å›²æ°—ãŒç†è§£ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚

https://github.com/jamiebuilds/the-super-tiny-compiler/blob/master/the-super-tiny-compiler.js#L363-L540

:::message
ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã¨ã„ã†åå‰ã§ã™ãŒã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯ LISP ã½ã„é«˜æ°´æº–è¨€èªã‚’ C ã½ã„é«˜æ°´æº–è¨€èªã«å¤‰æ›ã™ã‚‹ã®ã§ã€ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ©ã¨ã„ã†æ–¹ãŒæ­£ç¢ºã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã§ã™ãŒå…ƒã‚³ãƒ¼ãƒ‰ãŒã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãªã®ã§ã€æœ¬è¨˜äº‹ã§ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã§çµ±ä¸€ã—ã¾ã™ã€‚
ã¾ãŸã€ã€Œæ„å‘³è§£æã‚„æœ€é©åŒ–ãŒãªã„ãï¼ã€ã¨æ€ã†æ–¹ã‚‚ã„ã‚‹ã‹ã‚‚ã§ã™ãŒã€ãã‚Œã¯æµçŸ³ã« 200 è¡Œãªã®ã§ã”ã‚ã‚“ãªã•ã„ã€‚ã€‚
:::

:::message
ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã¯ã€åŒåƒšã® [@tktcorporation](https://twitter.com/tktcorporation) ã¨ [@yogo_yuichi](https://twitter.com/yogo_yuichi) ã«æ•™ãˆã¦ã‚‚ã‚‰ã„ã¾ã—ãŸã€‚æ„Ÿè¬ ğŸ™
:::

# æ©Ÿèƒ½ã”ã¨ã®æŒ¯ã‚Šè¿”ã‚Š

ä»Šå› The Super Tiny Compiler ãŸã å†™çµŒã™ã‚‹ã ã‘ã§ãªãã€ é–‹ç™ºä½“é¨“ã®è‰¯ã„ TypeScript with Deno ã§å†å®Ÿè£…ã—ã¦ã¿ã¾ã—ãŸã€‚ãã®ã‚³ãƒ¼ãƒ‰ã¨ã¨ã‚‚ã«å„æ©Ÿèƒ½å®Ÿè£…ã®æŒ¯ã‚Šè¿”ã‚Šã‚’è¨˜è¼‰ã—ã¾ã™ã€‚

ä»¥é™ã§ç´¹ä»‹ã™ã‚‹å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã§ã™ã€‚

https://github.com/kawamataryo/the-super-tiny-compiler-deno

å…ƒãƒªãƒã‚¸ãƒˆãƒªã§ã¯ã€ã™ã¹ã¦ 1 ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã‚‰ã‚Œã¦ã„ã¾ã™ãŒã€ä¸Šè¨˜ãƒªãƒã‚¸ãƒˆãƒªã§ã¯æ©Ÿèƒ½ã”ã¨ã«ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã—ã¦ã€ãã‚Œãã‚Œã« Unit Test ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚

## 1. Tokenizeï¼ˆå­—å¥è§£æï¼‰

![](/images/302577a69c06b7/2022-10-02-19-59-38.png)

Tokenize ã§ã¯ã€ã‚³ãƒ¼ãƒ‰ã®æ–‡å­—åˆ—ã‚’ã€`Token` ã¨ã„ã†ç¨®åˆ¥ã”ã¨ã«ãƒ©ãƒ™ãƒ«ä»˜ã‘ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—ã«å¤‰æ›ã—ã¾ã™ã€‚ã“ã“ã§è§£æã«ä¸è¦ãªç©ºç™½ãªã©ã¯å‰Šé™¤ã•ã‚Œã¾ã™ã€‚

```js
const token = [
  { type: "paren", value: "(" },
  { type: "name", value: "add" },
  { type: "number", value: "2" },
  { type: "number", value: "4" },
  { type: "paren", value: ")" },
];
```

ä»•çµ„ã¿çš„ã«ã¯ã€while ãƒ«ãƒ¼ãƒ—ã§ã‚³ãƒ¼ãƒ‰ã®æ–‡å­—åˆ—ã‚’ä¸€æ–‡å­—ãšã¤è§£æã—ã¦ã€ç¨®åˆ¥ã”ã¨ã«ãƒ©ãƒ™ãƒ«ã¨å€¤ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã—ã¦ã„ãå½¢ã§ã™ã€‚

https://github.com/kawamataryo/the-super-tiny-compiler-deno/blob/main/src/modules/tokenizer.ts#L1-L75

## 2. Parseï¼ˆæ§‹æ–‡è§£æï¼‰

![](/images/302577a69c06b7/2022-10-02-20-00-38.png)

Parse ã§ã¯ã€Token ã‚’ ASTï¼ˆæŠ½è±¡æ§‹æ–‡æœ¨ï¼‰ã«å¤‰æ›ã—ã¾ã™ã€‚

AST ã¯ã€ã‚³ãƒ¼ãƒ‰ã®æ§‹æ–‡æ§‹é€ ï¼ˆæ„å‘³ã‚’ç†è§£ã™ã‚‹ãŸã‚ã«å¿…è¦ãªæ§‹é€ ï¼‰ã‚’æœ¨æ§‹é€ ã§è¡¨ã—ãŸã‚‚ã®ã§ã™ã€‚
ã“ã“ã§ã€ã•ãã»ã©ã®`paren`ï¼ˆ`()`ï¼‰ãªã©ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å®Ÿè¡Œã«ä¸è¦ãªæƒ…å ±ã¯å–ã‚Šé™¤ã‹ã‚Œã¦ã€é–¢æ•°ã€å¼•æ•°ã€æ–‡ãªã©ã®ã¾ã¨ã¾ã‚Šã”ã¨ã«æ§‹é€ åŒ–ã•ã‚Œã¾ã™ã€‚

```js
const ast = {
  type: "Program",
  body: [
    {
      type: "CallExpression",
      name: "add",
      params: [
        {
          type: "NumberLiteral",
          value: "2",
        },
        {
          type: "NumberLiteral",
          value: "4",
        },
      ],
    },
  ],
};
```

https://github.com/kawamataryo/the-super-tiny-compiler-deno/blob/main/src/modules/parser.ts#L1-L67

## 3. Transform (å¤‰æ›)

![](/images/302577a69c06b7/2022-10-02-20-00-55.png)

Transform ã§ã¯å…ƒã‚³ãƒ¼ãƒ‰ã® AST ã‚’å‡ºåŠ›ã—ãŸã„æ§‹æ–‡æ§‹é€ ã‚’è¡¨ç¾ã™ã‚‹æ–°ã—ã„ AST ã«å¤‰æ›ã—ã¾ã™ã€‚

ã“ã“ã§ã¯ã€Traverser ã¨ã„ã† AST ã‚’å·¡å›ã™ã‚‹é–¢æ•°ã¨ã€ Transformer ã¨ã„ã† Traverser ã‚’ä½¿ã£ã¦å®Ÿéš›ã« AST ã‚’å¤‰æ›ã™ã‚‹é–¢æ•°ã‚’ä½œæˆã—ã¾ã™ã€‚

### Traverser

Traverser ã¯ AST ã‚’æ·±ã•å„ªå…ˆã§æ¢ç´¢ã™ã‚‹é–¢æ•°ã§ã™ã€‚
ast ã¨ visitorï¼ˆast ã®å„ãƒãƒ¼ãƒ‰ã®ã‚¿ã‚¤ãƒ—ã«ã‚ˆã£ã¦å®Ÿè¡Œã™ã‚‹å‡¦ç†ã‚’è¨­å®šã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰ã‚’å—ã‘å–ã‚Šã€å†…éƒ¨ã§å®šç¾©ã—ãŸ traverseArray ã¨ traverseNode ã¨ã„ã† 2 ã¤ã®é–¢æ•°ã‚’å†å¸°çš„ã«å‘¼ã³å‡ºã™ã“ã¨ã§ã€visitor ã«è¨­å®šã•ã‚ŒãŸ node ã®ç¨®åˆ¥ã«å¿œã˜ãŸå‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

Traverser ã«ã¯ã€ãƒãƒ¼ãƒ‰ã¸ãŸã©ã‚Šç€ã„ãŸæ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹`enter`ã¨ã€ãƒãƒ¼ãƒ‰ã®å­è¦ç´ ã‚’æ¢ç´¢ã—ã¦æˆ»ã£ã¦ããŸæ™‚ã«äº‹é …ã•ã‚Œã‚‹`leave`ã® 2 ã¤ã®å‡¦ç†å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒã‚ã‚Šã¾ã™ã€‚

https://github.com/kawamataryo/the-super-tiny-compiler-deno/blob/main/src/modules/traverser.ts#L1-L39

### Transformer

Transformer ã¯ AST ã‚’å—ã‘å–ã‚Šã€åˆ¥ã®æ§‹æ–‡æ§‹é€ ã‚’æŒã¤ AST ã«å¤‰æ›ã™ã‚‹é–¢æ•°ã§ã™ã€‚å†…éƒ¨ã§ã¯ã€ã•ãã»ã©å®šç¾©ã—ãŸ Traverser ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

å€‹äººçš„ã«ã“ã“ã®å®Ÿè£…ãŒã€1 ç•ªã®ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆã§ã—ãŸã€‚
æœ€åˆãªãœã€ã“ã®ã‚³ãƒ¼ãƒ‰ã§æ–°ã—ã„ AST ãŒå‡ºåŠ›ã§ãã‚‹ã®ã‹å…¨ç„¶ã‚ã‹ã‚‰ãšã€print ãƒ‡ãƒãƒƒã‚¯ã‚’ç¹°ã‚Šè¿”ã—ã¾ã—ãŸã€‚

ç†è§£ã®ãƒã‚¤ãƒ³ãƒˆã¯`CallExpression` ãƒãƒ¼ãƒ‰ã®å‡¦ç†ã«ã¦ã€ã²ã¨ã¤ã®`expression` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‚ç…§ã‚’ `expression.arguments` ã¨ã€`expression` è‡ªèº«ã§ä½¿ã„åˆ†ã‘ã¦ã€`node` ã¨ `parent` ãã‚Œãã‚Œã® `__context`ã«ç™»éŒ²ã—ã¦ã„ã‚‹ç‚¹ã§ã™ã€‚

å…ƒã‚³ãƒ¼ãƒ‰ã«ã‚‚ã‚³ãƒ¡ãƒ³ãƒˆã•ã‚Œã¦ã„ã¾ã™ãŒã“ã‚Œã¯ã€ã‹ãªã‚Š Hacky ãªã®ã§ã€ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼ã§ã“ã®å®Ÿè£…ã‚’ä½¿ã£ãŸ PR ãŒæ¥ãŸã‚‰ç›¸å½“å›°ã‚‹ã¨æ€ã„ã¾ã™ ğŸ˜…

https://github.com/kawamataryo/the-super-tiny-compiler-deno/blob/main/src/modules/transformer.ts#L1-L56

## 4. Code Generate

![](/images/302577a69c06b7/2022-10-02-20-01-41.png)

æœ€å¾Œã«ã€Transformer ã«ã‚ˆã£ã¦å¤‰æ›ã•ã‚ŒãŸ AST ã‹ã‚‰ã€æ–‡å­—åˆ—ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

ã“ã“ã¯ã¨ã¦ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ã§ã€Node ã®ã‚¿ã‚¤ãƒ—ã”ã¨ã«å†å¸°çš„ã«æ–‡å­—åˆ—åŒ–ã‚’ãŠã“ãªã„ã€è¦æ‰€ã§`()`ã‚„`;`ã€`\n`ãªã©ã‚³ãƒ¼ãƒ‰ã®æ§‹é€ ã‚’è¡¨ç¾ã™ã‚‹è¨˜å·ã‚’è¿½åŠ ã—ã¾ã™ã€‚

https://github.com/kawamataryo/the-super-tiny-compiler-deno/blob/main/src/modules/code_generator.ts#L1-L30

ã“ã‚Œã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®å®Ÿè£…ã¯ã™ã¹ã¦å®Œäº†ã§ã™ã€‚

ã„ã¾ã¾ã§ä½œã£ãŸé–¢æ•°ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã¨ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®ä¸€é€£ã®å‡¦ç†ã‚’è¡¨ç¾ã§ãã¾ã™ ğŸ‰

```ts
export const compiler = (code: string) => {
  const tokens = tokenizer(code);
  const ast = parser(tokens);
  const newAst = transformer(ast);
  const output = codeGenerator(newAst);
  return output;
};
```

# ãŠã‚ã‚Šã«

The Super Tiny Compiler ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®å‡¦ç†ã‚’å®Œçµã«ç†è§£ã™ã‚‹ãŸã‚ã®ã¨ã¦ã‚‚å„ªã‚ŒãŸæ•™æã ã¨æ€ã„ã¾ã™ã€‚
æ˜¯éè©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

The Super Tiny Compiler ã®æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦ã¯ã€[Go è¨€èªã§ä½œã‚‹ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿](https://www.oreilly.co.jp/books/9784873118222/) ã‚„ã€[Let's build a browser engine!](https://limpet.net/mbrubeck/2014/08/08/toy-layout-engine-1.html) ã‚‚ã‚ªã‚¹ã‚¹ãƒ¡ã§ã™ã€‚

https://www.oreilly.co.jp/books/9784873118222/

https://limpet.net/mbrubeck/2014/08/08/toy-layout-engine-1.html
