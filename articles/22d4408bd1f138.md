---
title: "fast-check ã§ Property Based Testing ã‚’è©¦ã—ã¦ã¿ã‚‹"
emoji: "ğŸ’"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["fast-check","typescript","test", "jest"]
published: false
---

Property Based Testing ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã® fast-check ã‚’è©¦ã—ã¦ã¿ãŸã®ã§ã¾ã¨ã‚ã¾ã™ã€‚

# Property Based Testingã¨ã¯ï¼Ÿ

Property Based Testing ã¯ã€Haskell ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª [QuickCheck](https://hackage.haskell.org/package/QuickCheck) ã‹ã‚‰å§‹ã¾ã£ãŸãƒ†ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã§ã™ã€‚Property Based Testing ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«å…¥åŠ›å€¤ã®æ¡ä»¶ã‚’æ¸¡ã™ã¨ã€ãã®æ¡ä»¶ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ãªè¤‡æ•°ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è‡ªå‹•ç”Ÿæˆã—å®Ÿè¡Œã—ã¦ãã‚Œã¾ã™ã€‚æ‰‹å‹•ã§ã¯ã¨ã¦ã‚‚æ›¸ã‘ãªã„è†¨å¤§ãªãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’æ¤œè¨¼å‡ºæ¥ã‚‹ã®ã§ã€ãƒ†ã‚¹ãƒˆã‚’æ›¸ãé–‹ç™ºè€…ãŒæ„å›³ã—ã¦ã„ãªã„ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã‚’ç™ºè¦‹ã§ãã‚‹ã¨ã„ã†ãƒ¡ãƒªãƒƒãƒˆãªã©ãŒã‚ã‚Šã¾ã™ã€‚

ï¼ˆå‚è€ƒï¼‰

https://kotest.io/docs/proptest/property-based-testing.html

https://medium.com/criteo-engineering/introduction-to-property-based-testing-f5236229d237

# fast-checkã¨ã¯ï¼Ÿ

fast-check ã¯ JavaScript ã§ Property Based Testing ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚

https://github.com/dubzzz/fast-check

Jest ã‚„ mocha ãªã©ã®ãƒ†ã‚¹ãƒˆãƒ†ã‚£ãƒ³ã‚°ãƒ•ãƒ¬ãƒ¼ãƒ ã¨ä½µç”¨ã—ã€åŸºæœ¬ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ›¸ãæ–¹ã¨ãªã‚Šã¾ã™ã€‚

```ts
it('sample test', () => {
  fc.assert( // Property Based Testing ã®ãƒ©ãƒ³ãƒŠãƒ¼
    fc.property(
      fc.nat(), // å…¥åŠ›å€¤ã®æ¡ä»¶ã€‚ nat()ã¯æ­£ã®æ•´æ•°
      num => { // å®Ÿéš›ã«expectã‚’å®Ÿè¡Œã™ã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã€‚å¼•æ•°ã«ã¯å…¥åŠ›å€¤ã®æ¡ä»¶ã«æ²¿ã£ã¦ç”Ÿæˆã•ã‚ŒãŸãƒ©ãƒ³ãƒ€ãƒ ãªå€¤ãŒå…¥ã‚‹
        expect(testMethod(num)).toBe('FizzBuzz')
      }
    )
  )
})
```

`fc.property`ã®å†…éƒ¨ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ 100 å›å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

ã¾ãŸã€å…¥åŠ›å€¤ã®æ¡ä»¶ã¯ä»Šå›`fc.nat()`ï¼ˆæ­£ã®æ•´æ•°ï¼‰ã¨ã—ã¾ã—ãŸãŒã€ä»–ã«ã‚‚ Booleanã€String ãªã©ã®åŸºæœ¬ãƒ‡ãƒ¼ã‚¿å‹ã‹ã‚‰ã€Jsonã€Dateã€uuid ç­‰ã®ã‚«ã‚¹ã‚¿ãƒ ãªãƒ‡ãƒ¼ã‚¿å‹ã¾ã§æŸ”è»Ÿã«æŒ‡å®šã§ãã¾ã™ã€‚

ä»¥ä¸‹ã¯`id`ã€`name`ã€`age`ã€`birthday`ã®ã‚­ãƒ¼ã‚’æŒã¤æ§‹é€ ä½“ã‚’å…¥åŠ›æ¡ä»¶ã¨ã—ãŸã„å ´åˆã®ä¾‹ã§ã™ã€‚

```ts
fc.record({
  id: fc.uuidV(4),
  name: fc.constantFrom('Paul', 'Luis', 'Jane', 'Karen'),
  age: fc.nat(99),
  birthday: fc.date({min: new Date("1970-01-01T00:00:00.000Z"), max: new Date("2100-12-31T23:59:59.999Z")})
}

// å‡ºåŠ›ä¾‹
// â€¢ {"id":"00000010-e2be-4b98-8d3a-944affffffe2","age":4,"birthday":new Date("2100-12-31T23:59:59.959Z")}
// â€¢ {"id":"00000001-0005-4000-bfff-fff03ec646bf","age":48,"birthday":new Date("2069-12-20T11:27:18.998Z")}
// â€¢ {"id":"00000003-ffed-4fff-bfff-fff400000012","name":"Jane","birthday":new Date("2028-02-06T17:18:26.370Z")}
// â€¢ {"id":"fa5630bc-000f-4000-8000-001600000018","age":0,"birthday":new Date("1970-01-01T00:00:00.039Z")}
// â€¢ {"id":"00000018-ffee-4fff-8a22-b8770000001b","age":93}
// â€¢ â€¦
```

æŒ‡å®šå‡ºæ¥ã‚‹æ¡ä»¶ã®è©³ç´°ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèªãã ã•ã„ã€‚

https://github.com/dubzzz/fast-check/blob/main/documentation/Arbitraries.md#combinators

ä»–ã«ã‚‚ã€ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®å†ç¾æ©Ÿèƒ½ãªã©ã€Property Based Testing ã«å¿…è¦ãªæ©Ÿèƒ½ãŒç¶²ç¾…ã•ã‚Œã¦ã„ã¾ã™ã€‚

# FizzBuzz ã§Property Based Testing ã‚’è©¦ã—ã¦ã¿ã‚‹

å®šç¾©ã‚’è¦‹ã¦ã‚‚ã„ã¾ã„ã¡ä¾¿åˆ©ã•ãŒåˆ†ã‹ã‚Šã«ãã„ã®ã§ã€ç°¡å˜ãªä¾‹ã¨ã—ã¦ FizzBuzz ã§è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚
FizzBuzz ã®æ¡ä»¶ã¯è‰²ã€…ã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯æ•´æ•°ã‚’ä¸ãˆãŸå ´åˆã«ä»¥ä¸‹ã®æ¡ä»¶ã§å€¤ã‚’è¿”ã™é–¢æ•°ã¨ã—ã¾ã™ã€‚

- 3 ã®å€æ•°ã§ã‹ã¤ 5 ã®å€æ•°ã®å ´åˆã¯`FizzBuzz`
- 3 ã®å€æ•°ã®å ´åˆã¯`Fizz`
- 5 ã®å€æ•°ã®å ´åˆã¯`Buzz`
- ãã‚Œä»¥å¤–ã¯ä¸ãˆã‚‰ã‚ŒãŸæ•°å€¤ã‚’è¿”ã™

å®Ÿè£…ã¯ã“ã¡ã‚‰ã§ã™ã€‚

```ts
type FizzBuzzReturn = "FizzBuzz" | "Fizz" | "Buzz" | number

export const fizzBuzz = (num: number): FizzBuzzReturn => {
  if(num % 3 === 0 && num % 5 === 0) {
    return "FizzBuzz"
  }
  if(num % 3 === 0) {
    return "Fizz"
  }
  if(num % 5 === 0) {
    return "Buzz"
  }
  return num
}
```

ã“ã®é–¢æ•°ã‚’æ„šç›´ã«ãƒ†ã‚¹ãƒˆã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

```ts
describe('fizzBuzz', () => {
  test('3ã®å€æ•°ã§ã‹ã¤5ã®å€æ•°ã®å ´åˆã¯FizzBuzzã¨è¿”ã™', () => {
    expect(fizzBuzz(15)).toBe('FizzBuzz')
    expect(fizzBuzz(90)).toBe('FizzBuzz')
    expect(fizzBuzz(180)).toBe('FizzBuzz')
  })

  test('3ã®å€æ•°ã§ã‹ã¤5ã®å€æ•°ã§ã¯ãªã„å ´åˆã¯Fizzã¨è¿”ã™', () => {
    expect(fizzBuzz(3)).toBe('Fizz')
    expect(fizzBuzz(9)).toBe('Fizz')
    expect(fizzBuzz(63)).toBe('Fizz')
  })

  test('5ã®å€æ•°ã§ã‹ã¤3ã®å€æ•°ã§ã¯ãªã„å ´åˆã¯Buzzã¨è¿”ã™', () => {
    expect(fizzBuzz(5)).toBe('Buzz')
    expect(fizzBuzz(35)).toBe('Buzz')
    expect(fizzBuzz(80)).toBe('Buzz')
  })

  test('3ã®å€æ•°ã§ã‚‚5ã®å€æ•°ã§ã‚‚ãªã„å ´åˆã¯å¼•æ•°ã‚’ãã®ã¾ã¾è¿”ã™', () => {
    expect(fizzBuzz(1)).toBe(1)
    expect(fizzBuzz(26)).toBe(26)
    expect(fizzBuzz(98)).toBe(98)
  })
})
```

Jest ã®`test.each`ã‚’ä½¿ã£ã¦ Parameterized Test çš„ã«æ›¸ã‘ã°ã‚‚ã£ã¨åŠ¹ç‡çš„ã«æ›¸ã‘ãã†ã§ã™ãŒã€ãã‚Œã§ã‚‚æ¤œè¨¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã¯é™ç•ŒãŒã‚ã‚Šã¾ã™ã€‚ãŸã¨ãˆã°ã€10,000,000 ç­‰å¤§ããªæ•°ã‚’ä¸ãˆãŸå ´åˆã«å®Ÿã¯ãƒã‚°ãŒã‚ã‚‹ã‹ã‚‚çŸ¥ã‚Œã¾ã›ã‚“ãŒã€æ¤œè¨¼ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ç„¡ç†ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã‚Œã‚’ fast-check ã‚’ä½¿ã£ã¦ Property Based Testing ã§æ›¸ãç›´ã™ã¨ã“ã¡ã‚‰ã§ã™ã€‚


```ts
describe('fizzBuzz', () => {
  test('3ã®å€æ•°ã§ã‹ã¤5ã®å€æ•°ã®å ´åˆã¯FizzBuzzã¨è¿”ã™', () => {
    fc.assert(
      fc.property(fc.nat(), num => {
        fc.pre(num % 3 === 0)
        fc.pre(num % 5 === 0)
        expect(fizzBuzz(num)).toBe('FizzBuzz')
      })
    )
  })

  test('3ã®å€æ•°ã§ã‹ã¤5ã®å€æ•°ã§ã¯ãªã„å ´åˆã¯Fizzã¨è¿”ã™', () => {
    fc.assert(
      fc.property(fc.nat(), num => {
        fc.pre(num % 3 === 0)
        fc.pre(num % 5 !== 0)
        expect(fizzBuzz(num)).toBe('Fizz')
      })
    )
  })

  test('5ã®å€æ•°ã§ã‹ã¤3ã®å€æ•°ã§ã¯ãªã„å ´åˆã¯Buzzã¨è¿”ã™', () => {
    fc.assert(
      fc.property(fc.nat(), num => {
        fc.pre(num % 5 === 0)
        fc.pre(num % 3 !== 0)
        expect(fizzBuzz(num)).toBe('Buzz')
      })
    )
  })

  test('3ã®å€æ•°ã§ã‚‚5ã®å€æ•°ã§ã‚‚ãªã„å ´åˆã¯å¼•æ•°ã‚’ãã®ã¾ã¾è¿”ã™', () => {
    fc.assert(
      fc.property(fc.nat(), num => {
        fc.pre(num % 3 !== 0)
        fc.pre(num % 5 !== 0)
        expect(fizzBuzz(num)).toBe(num)
      })
    )
  })
})
```

`fc.pre()`ã¯å¼•æ•°ã«æ¸¡ã—ãŸæ¡ä»¶å¼ãŒæ­£ã®å ´åˆã¯æ¤œè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹é–¢æ•°ã§ã™ã€‚

:::message
ä»Šå›ã¯åˆ†ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã«å€¤ã®èª¿æ•´ã«`fc.pre()`ã‚’ä½¿ã£ãŸã®ã§ã™ãŒã€`filter`ã§èª¿æ•´ã™ã‚‹æ–¹æ³•ã‚„ã€`map`ã‚’ä½¿ã„ç”Ÿæˆå€¤åŠ å·¥ã—ã¦æ¤œè¨¼ã™ã‚‹æ–¹æ³•ãªã©æ§˜ã€…ã‚ã‚Šã¾ã™ã€‚

- [pre](https://github.com/dubzzz/fast-check/blob/main/documentation/Tips.md#filter-invalid-combinations-using-pre-conditions)
- [filter](https://github.com/dubzzz/fast-check/blob/main/documentation/AdvancedArbitraries.md#filter-values)
- [map](https://github.com/dubzzz/fast-check/blob/main/documentation/AdvancedArbitraries.md#transform-values)
:::

fast-check ã§ã¯ã€æ¨™æº–ã§å„ã‚¢ã‚µãƒ¼ãƒˆã«å¯¾ã—ã¦ 100 å›ã®ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã®ã§ã€å‰ã®ãƒ†ã‚¹ãƒˆã«æ¯”ã¹ã¦ã‹ãªã‚Šãƒã‚°ã‚’è¦‹ã¤ã‘ã‚„ã™ããªã‚Šã¾ã™ã€‚

å®Ÿéš›ã«`console.log()`ã§å¼•æ•°ã«ä¸ãˆã‚‰ã‚Œã‚‹æ•°å€¤ã‚’å‡ºåŠ›ã—ã¦ã¿ã‚‹ã¨ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã—ãŸã€‚
ã‹ãªã‚Šå¹…åºƒã„å€¤ã§æ¤œè¨¼ã—ã¦ã„ã‚‹ã®ãŒã‚ã‹ã‚‹ã¨æ€ã„ã¾ã™ã€‚

```ts
  test('3ã®å€æ•°ã§ã‹ã¤5ã®å€æ•°ã®å ´åˆã¯FizzBuzzã¨è¿”ã™', () => {
    const args: number[] = []
    fc.assert(
      fc.property(fc.nat(), num => {
        fc.pre(num % 3 === 0)
        fc.pre(num % 5 === 0)
        args.push(num)
        expect(fizzBuzz(num)).toBe('FizzBuzz')
      })
    )
    console.log(args)
  })
    // å‡ºåŠ› â†“
    //  [
    //             15,  5154547515, 14586534285, 22067216670, 11463699000,
    //             15,         150,         405, 24544203645, 15800293260,
    //    32212254585, 25782162600, 19507501455, 13932433035, 32212254465,
    //            240,  5894415900,  2475945960,  7330825875, 32212254630,
    //    29224485450,         240, 29473233660,         390,  8133294240,
    //    30365121465, 32212254420, 10316546130, 15568267905, 14022727380,
    //            450, 28486437015,          90, 16389325920,  1924987605,
    //    31884552180,         450,         330, 32212254345,   817391010,
    //    22209798855, 32212254330, 20007343365, 24800565105,   633917550,
    //    27951496950,  8008404135,  2756876070,  7432837200, 16562011815,
    //    13111531425,         165,   372921390, 28326375945, 30538334280,
    //    25317536220,         180, 18038638425, 32212254675,         180,
    //    21342528135, 32212254585, 13922248920, 11444807085, 31396742475,
    //    32212254705, 21541350405, 26881353345, 30568548300, 32212254705,
    //    32212254285,  7907215245, 18255486015,  8624909925,  8417630310,
    //             90,  4360582020,         300, 13438857525,         120,
    //    19155723930, 32212254555,  8267478945, 32212254270,         285,
    //    16459253745, 20202074865,  1353827010,  6384282060, 25864471440,
    //    15372941925, 11600763255,   928093095, 32212254465,  8311722375,
    //    18542294235, 23017659225,         240, 21950595210,  4564644165
    //  ]
```


# ãŠã‚ã‚Šã«

ä»¥ä¸Šã€Property Based Testing ã®ç´¹ä»‹ã§ã—ãŸã€‚ä»Šå›åˆã‚ã¦è§¦ã£ãŸã®ã§ã™ãŒã€æ€ã£ãŸã‚ˆã‚Šä¾¿åˆ©ã«ä½¿ãˆãã†ã§ã™ã€‚å®Ÿéš›ã«ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰æ›¸ã„ã¦ã„ã‚‹ã¨ãã«è‡ªåˆ†ã® FizzBuzz ã®ã‚³ãƒ¼ãƒ‰ã®ãƒã‚°ã‚’ãƒ†ã‚¹ãƒˆã‹ã‚‰ç™ºè¦‹ã§ããŸã‚Šã‚‚ã—ã¾ã—ãŸã€‚
fast-check ã® API ã‚‚ã¨ã¦ã‚‚åˆ†ã‹ã‚Šã‚„ã™ã„ã®ã§ã€ä»Šä½œã£ã¦ã„ã‚‹ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã«ã‚‚é“å…¥æ¤œè¨ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ï¼

# å‚è€ƒ

- [ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ™ãƒ¼ã‚¹ãƒ»ãƒ†ã‚¹ãƒˆã‚’ç¿’å¾—ã™ã‚‹](https://blogs.oracle.com/otnjp/post/know-for-sure-with-property-based-testing-ja)
- [Introduction to Property Based Testing | by Nicolas Dubien | Criteo R&D Blog | Medium](https://medium.com/criteo-engineering/introduction-to-property-based-testing-f5236229d237)
- [Property-based Testing | Kotest](https://kotest.io/docs/proptest/property-based-testing.html)
- [Property Based Testing ã§ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹](https://gakuzzzz.github.io/slides/property_based_testing_for_domain/#1)