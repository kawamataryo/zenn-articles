---
title: "OpenAIã®Chat Completion APIã‚’ä½¿ã£ã¦ã€ChatGPTãƒ©ã‚¤ã‚¯ã«ä¼šè©±ãŒã§ãã‚‹SlackBotã‚’ä½œã‚‹"
emoji: "ğŸ¤–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["slack", "chatgpt", "gpt3", "openai"]
published: false
---

[ä»¥å‰ã®è¨˜äº‹](https://zenn.dev/ryo_kawamata/articles/291c95b41baeb7)ã§ã¯ã€`GPT3` ã® Completion API ã‚’ä½¿ã£ã¦ Chat GPT ãƒ©ã‚¤ã‚¯ãª Slack Bot ã‚’ä½œã£ã¦ã„ã¾ã—ãŸãŒã€ 2023/03/02ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰ã¤ã„ã« `GPT-3.5` ã‚’ä½¿ã† [Chat Completion API](https://platform.openai.com/docs/guides/chat) ãŒå…¬é–‹ã•ã‚ŒãŸã®ã§ã€æ—©é€Ÿãã¡ã‚‰ã‚’ä½¿ã£ã¦ Slack Bot ã‚’ä½œã£ã¦ã¿ã¾ã—ãŸã€‚

https://openai.com/blog/introducing-chatgpt-and-whisper-apis

# ğŸ¤– ä½œã£ãŸã‚‚ã®

Chat GPT ã®ã‚ˆã†ã«å‰å¾Œã®ä¼šè©±ã‚’è€ƒæ…®ã—ã¦å›ç­”ã—ã¦ãã‚Œã‚‹ Slack Bot ã§ã™ã€‚

![](/images/56ea2484320def/sample.gif)

:::message
[ChatGPT ã«æ„Ÿæƒ…å›è·¯ã‚’åŸ‹ã‚è¾¼ã‚“ã ã‚‰ã€ã‚„ã¹ã‡æ„Ÿã˜ã«ãªã£ãŸï½œæ·±æ´¥ è²´ä¹‹ (fladdict)ï½œ note](https://note.com/fladdict/n/n5043e6e61ce3)ã‚’å‚è€ƒã«ä¼šè©±ã—ã¦ã„ã¾ã™ã€‚
:::

## ğŸ› ï¸ å®Ÿè£…

Slack ã® API ã§ã‚¹ãƒ¬ãƒƒãƒ‰ã®å†…å®¹ã‚’å–å¾—ã—ã€ãã‚Œã‚’ Chat Completion API ã«æ¸¡ã™ã“ã¨ã§ Chat GPT ã®ã‚ˆã†ã«å‰å¾Œã®ä¼šè©±ã‚’è€ƒæ…®ã—ãŸå›ç­”ã‚’è¿”ã—ã¦ãã‚Œã¾ã™ã€‚

ä»¥ä¸‹ Slack ã®[Bolt ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯](https://slack.dev/bolt-js/concepts) ã‚’ã¤ã‹ã£ãŸå ´åˆã®å®Ÿè£…ä¾‹ã§ã™ã€‚

```ts
export const useReplyEvent = (app: App) => {
  app.event("message", async ({ event, client, logger }) => {
    const { thread_ts: threadTs, bot_id: botId, text } = event as any;
    // botã®è¿”ä¿¡ã¾ãŸã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
    if (botId || !threadTs) {
      return;
    }

    // ã‚¹ãƒ¬ãƒƒãƒ‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
    const threadMessagesResponse = await client.conversations.replies({
      channel: event.channel,
      ts: threadTs,
    });
    const messages = threadMessagesResponse.messages?.sort(
      (a, b) => Number(a.ts) - Number(b.ts)
    );

    // GPT Botã¸ã®è¿”ä¿¡ã§ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
    if (!(messages![0].text?.includes(GPT_BOT_NAME) && messages![0].bot_id)) {
      return;
    }

    try {
      // ã‚¹ãƒ¬ãƒƒãƒ‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
      const prevMessages = messages!.slice(1).map((m) => {
        const role = m.bot_id
          ? ChatCompletionRequestMessageRoleEnum.Assistant
          : ChatCompletionRequestMessageRoleEnum.User;
        return { role: role, content: m.text as string };
      });

      const configuration = new Configuration({
        apiKey: config.openai.key,
      });
      const openAIClient = new OpenAIApi(configuration);

      // Chat Completion API ã‚’å‘¼ã³å‡ºã™
      const response = await openAIClient.createChatCompletion({
        model: "gpt-3.5-turbo",
        // ä»¥ä¸‹ã§ä¼šè©±éƒ¨åˆ†ã‚’çµ„ã¿ç«‹ã¦ã‚‹
        messages: [
          {
            role: ChatCompletionRequestMessageRoleEnum.System,
            content: CHAT_GPT_SYSTEM_PROMPT,
          },
          ...prevMessages,
          {
            role: ChatCompletionRequestMessageRoleEnum.User,
            content: text as string,
          },
        ],
      });
      const message = response.data.choices[0].message?.content || "";

      // å›ç­”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ç¨¿ã™ã‚‹
      if (message) {
        await postAsGptBot({
          client,
          channel: event.channel,
          threadTs,
          text: message,
        });
      } else {
        throw new Error("message is empty");
      }
    } catch (e) {
      logger.error(e);
      await postAsGptBot({
        client,
        channel: event.channel,
        threadTs,
        text: "å¤§å¤‰ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚",
      });
    }
  });
};
```

Chat Completion API ã«æ¸¡ã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã¯`role`ã¨`content`ã® 2 ã¤ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚Šã¾ã™ã€‚
ãã‚Œã‚’ Slack Bot å´ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å´ã§é©åˆ‡ã«åˆ†ã‘ã¦æ¸¡ã™ã“ã¨ãŒé‡è¦ã§ã™ã€‚

```json
[
  { "role": "system", "content": "You are a helpful assistant." },
  { "role": "user", "content": "Who won the world series in 2020?" },
  { "role": "assistant", "content": "The Los Angeles Dodgers won the World" },
  { "role": "user", "content": "Where was it played?" }
]
```

https://platform.openai.com/docs/guides/chat/introduction

ã¾ãŸ API ã¸æœ€åˆã«æ¸¡ã™ `system` ãƒ­ãƒ¼ãƒ«ã® prompt ã®éƒ¨åˆ†ã‚‚å¤§åˆ‡ã§ã™ã€‚
ä»Šå›ã¯ Slack ã® formatting ã‚’è€ƒæ…®ã—ã¦ã€è¿”ç­”ã—ã¦ãã‚Œã‚‹ã‚ˆã†ã«ä»¥ä¸‹ã®ã‚ˆã†ãª Prompt ã‚’æ¸¡ã—ã¦ã„ã¾ã™ã€‚

```ts
export const CHAT_GPT_SYSTEM_PROMPT = `
You are an excellent AI assistant Slack Bot.
Please output your answer message according to slack's markdown format as follows.

# Format
bold: *bold*
italic: _italic_
strikethrough: ~strikethrough~
code: \`code\`
link: <https://slack.com>
block: \`\`\` code block \`\`\`
bulleted list: * item1

# Notes
Be sure to include a space before and after the single quote in the sentence
ex) \`code\` -> (space)\`code\`(space)
`;
```

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿéš›ã«å®Ÿè£…ã—ãŸ PR ã§ã™ã€‚

[https://github.com/kawamataryo/tell-me-bot/pull/12/files](https://github.com/kawamataryo/tell-me-bot/pull/12)

ä»¥å‰è¨˜äº‹ã§ç´¹ä»‹ã—ãŸ tell-me-bot ã¨ã„ã†ä¾¿åˆ©ãªè³ªå•å›ç­” Bot ã«ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚

https://zenn.dev/ryo_kawamata/articles/tell-me-bot-slack-app

## ãŠã‚ã‚Šã«

Slack ã§ Chat GPT ãŒä½¿ãˆã‚‹ã®ã¯æœ€é«˜ã«ä¾¿åˆ©ï¼
Open AI ã® API ã¯ä»Šå¾Œã‚‚é€²åŒ–ã—ã¦ã„ãã¨æ€ã†ã®ã§ã€æ¥½ã—ã¿ã§ã™ã€‚
