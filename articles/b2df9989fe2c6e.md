---
title: "webpack to Rspack ~ Rspackç§»è¡Œã®çµæœã¨æ³¨æ„ç‚¹ ~"
emoji: "ğŸ¦€"
type: "tech"
topics: ["rspack", "webpack"]
published: false
---

ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«ã‚’ webpack ã‹ã‚‰ Rspack ã«ç§»è¡Œã—ãŸã®ã§ã€ãã®çµŒç·¯ã¨æ³¨æ„ç‚¹ã‚’ã¾ã¨ã‚ã¾ã™ã€‚

:::message
[Rspack v1.0.7](https://github.com/web-infra-dev/rspack/releases/tag/v1.0.7) æ™‚ç‚¹ã§ã®æƒ…å ±ã§ã™ã€‚
:::

# ğŸ¦€ Rspackã¨ã¯ï¼Ÿ

**Rustã§æ›¸ã‹ã‚ŒãŸé«˜é€ŸãªJavaScriptã®ãƒãƒ³ãƒ‰ãƒ«ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚** webpackã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã¨ã®å¼·åŠ›ãªäº’æ›æ€§ã‚’æŒã¡ã¾ã™ã€‚

2024/08/24ã«v1.0.0ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¾ã—ãŸã€‚

https://rspack.dev/

# ğŸ¤” ãªãœRspackã«ç§»è¡Œã—ãŸã®ã‹ï¼Ÿ

ãƒ“ãƒ«ãƒ‰é€Ÿåº¦æ”¹å–„ã®ãŸã‚ä»¥å‰ã‹ã‚‰webpackã®ç§»è¡Œã‚’æ¤œè¨ã—ã¦ã„ã¾ã—ãŸãŒã€ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãŒwebpackä¾å­˜ã®æ§‹æˆ[^1]ã§ã€Viteã‚„ãã®ä»–ã®ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«ã¸ã®ç§»è¡ŒãŒå°‘ã—é¢å€’ã§ã—ãŸã€‚  **Rspackã§ã‚ã‚Œã°webpackã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚‚ãã®ã¾ã¾å‹•ãã€ç§»è¡ŒãŒå®¹æ˜“ã‹ã¤é€Ÿåº¦æ”¹å–„ãŒè¦‹è¾¼ã¾ã‚Œã‚‹**ãŸã‚Rspackã¸ã®ç§»è¡Œã‚’é¸ã³ã¾ã—ãŸã€‚

[^1]: [django-webpack-loader](https://github.com/django-webpack/django-webpack-loader)ã§webpackã®å‡ºåŠ›ã™ã‚‹statsã‚’èª­ã¿è¾¼ã¿ã€djangoãŒã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã¨ãªã‚‹htmlã‚’é…ä¿¡ã™ã‚‹æ§‹æˆã€‚

# ğŸ’¡ ç§»è¡Œæ–¹æ³•

ç§»è¡Œæ–¹æ³•ã¯ã€rspackã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã® [migrate from webpack](https://rspack.dev/guide/migration/webpack) ã‚’ãã®ã¾ã¾å‚è€ƒã«ã—ã¦é€²ã‚ã¾ã—ãŸã€‚ãã‚Œã ã‘ã§ã€devã‚‚producitonã‚‚ãƒ“ãƒ«ãƒ‰ã¯é€šã£ãŸã®ã§æœ¬å½“ã«æ¥½ã§ã—ãŸã€‚

ä¿®æ­£å†…å®¹

- webpack.config.js ã‚’ rspack.config.js ã«å¤‰æ›´
- `const webpack = require('webpack')` ã‚’ `const rspack = require('@rspack/core')` ã«å¤‰æ›´
- `MiniCssExtractPlugin` ãªã©ç‰¹å®šã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ `rspack` ã®åŒç­‰ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«å¤‰æ›´
- `ts-loader` ãªã©ç‰¹å®šã®ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’ `rspack` ã®ãƒ“ãƒ«ãƒˆã‚¤ãƒ³ã®ãƒ­ãƒ¼ãƒ€ãƒ¼ã«å¤‰æ›´
- èµ·å‹•ã‚³ãƒãƒ³ãƒ‰ã‚’ `webpack` ã‹ã‚‰ `rspack` ã«å¤‰æ›´

https://rspack.dev/guide/migration/webpack

:::message
ãƒ­ãƒ¼ãƒ€ãƒ¼ã¯webpackã®ã‚‚ã®ã‚‚ãã®ã¾ã¾å‹•ãã¾ã™ãŒã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’è€ƒæ…®ã—rspackã®ãƒ“ãƒ«ãƒˆã‚¤ãƒ³ã®ãƒ­ãƒ¼ãƒ€ãƒ¼ã«å¤‰æ›´ã—ã¦ã„ã¾ã™ã€‚
:::

:::message
ç§ã®ã‚±ãƒ¼ã‚¹ã§ã¯ã¨ãã«å‹•ã‹ãªã„webpackãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸãŒã€Rspackã‚‚ã¾ã å®Œç’§ã§ã¯ãªã„ã®ã§ã€ç§»è¡Œå‰ã«å‹•ã‹ãªã„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒãªã„ã‹ç¢ºèªã—ã¦ãŠãã¨è‰¯ã„ã§ã™ã€‚
ä»¥ä¸‹ã«ã¾ã¨ã¾ã£ã¦ã„ã¾ã™ã€‚

https://rspack.dev/guide/compatibility/plugin
:::

# ğŸ‰ ç§»è¡Œçµæœ

ä»¥ä¸‹ã€ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ‰ã—ãŸçµæœã®æ¯”è¼ƒã§ã™ã€‚

ğŸ“¦ ãƒãƒ³ãƒ‰ãƒ«å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«æ•°

- TypeScript: 390
- Vue.js: 360
- Media File: 100

ğŸ’» PC spec

- CPU: Apple M1 Max
- RAM: 32GB

## developmentãƒ“ãƒ«ãƒ‰

| ãƒ„ãƒ¼ãƒ«    | 5å›å®Ÿè¡Œã®å¹³å‡æ™‚é–“   |
|-----------|--------:|
| webpack   | 18.0s  |
| **rspack**    | **8.0s** |


ï¼ˆå·¦ãŒwebpackã€å³ãŒrspackï¼‰
https://youtu.be/Ov7tx4OpuUw

## productionãƒ“ãƒ«ãƒ‰

| ãƒ„ãƒ¼ãƒ«    | 5å›å®Ÿè¡Œã®å¹³å‡æ™‚é–“   |
|-----------|--------:|
| webpack   | 24.5s |
| **rspack**    | **8.7s**  |

ï¼ˆå·¦ãŒwebpackã€å³ãŒrspackï¼‰
https://youtu.be/mlETuonf2n8


çˆ†é€Ÿ ğŸš€

# ğŸš¨ ç§»è¡Œæ™‚ã®æ³¨æ„ç‚¹

devãƒ“ãƒ«ãƒ‰ã¯ã¨ãã«ç§»è¡Œã«è©°ã¾ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æœ¬å½“ã«Migrationã‚¬ã‚¤ãƒ‰ã«ã—ãŸãŒã£ã¦ç§»è¡Œã—ãŸã ã‘ã§å‹•ãã¾ã—ãŸã€‚ãŸã ã€prodãƒ“ãƒ«ãƒ‰ã¯ä¸­ã€…è©°ã¾ã‚Šã©ã“ã‚ãŒã‚ã‚Šã¾ã—ãŸãƒ»ãƒ»ã€‚

## â‘  CSSã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã§ç”»é¢ãŒçœŸã£ç™½ 

Rspackã®[cssExtractRspackPlugin](https://rspack.dev/plugins/rspack/css-extract-rspack-plugin) ã§å‡ºåŠ›ã•ã‚Œã‚‹CSSã®ãƒ•ã‚¡ã‚¤ãƒ«åã¨ã€bundleã•ã‚ŒãŸJSãŒèª­ã¿è¾¼ã¿å…ˆã¨ã—ã¦æŒ‡å®šã™ã‚‹CSSãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚·ãƒ¥ãŒå¾®å¦™ã«ç•°ãªã‚Šï¼ˆJSã‹ã‚‰èª­ã¿è¾¼ã¿å…ˆã¨ã—ã¦æŒ‡å®šã•ã‚Œã‚‹ãƒ‘ã‚¹ã§ã¯20æ–‡å­—ãƒãƒƒã‚·ãƒ¥ã€å®Ÿéš›ã®å‡ºåŠ›ã¯32æ–‡å­—ãƒãƒƒã‚·ãƒ¥ï¼‰ã€CSSã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã€‚ç”»é¢ãŒçœŸã£ç™½ã«ãƒ»ãƒ»

### å¯¾å¿œ
å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«åã®`[name].[contenthash].css`ã‚’`[name].[contenthash:20].css`ã¨ãƒãƒƒã‚·ãƒ¥ã®é•·ã•ã‚’20ã«å›ºå®šã—ã¦è§£æ±ºï¼ˆæŒ‡å®šãªã—ã ã¨ã€32æ–‡å­—ã§å‡ºåŠ›ã€‚JSã®ãƒãƒƒã‚·ãƒ¥ã¯æ¨™æº–ã§20æ–‡å­—ï¼‰ã€‚CssExtractRspackPluginã®ãƒã‚°ãªã®ã‹ã€ä»–ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ã®äº’æ›æ€§ã®å•é¡Œãªã®ã‹èª¿æŸ»ä¸­ã€‚

```diff:rspack.config.js
plugins: [
    new rspack.CssExtractRspackPlugin({
-      filename: '[name].[contenthash].css',
+      filename: '[name].[contenthash:20].css',
    }),
]
```
## â‘¡ ä¸€éƒ¨ã‚¹ã‚¿ã‚¤ãƒ«ãŒé©å¿œã•ã‚Œãšç”»é¢ãŒå´©ã‚Œã‚‹

è‡ªç¤¾ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’sassã§node_modulesã‹ã‚‰importã—ã¦ã„ã¾ã—ãŸãŒã€ãªãœã‹prodãƒ“ãƒ«ãƒ‰ã§ã¯ãƒãƒ³ãƒ‰ãƒ«ã‹ã‚‰é™¤å¤–ã€‚ä¸€éƒ¨CSSãŒèª­ã¿è¾¼ã¾ã‚Œãšã€ãƒ‡ã‚¶ã‚¤ãƒ³å´©ã‚ŒãŒç™ºç”Ÿã€‚

```scss:style.scss
// ã“ã‚Œã ã‘ãƒãƒ³ãƒ‰ãƒ«ã‹ã‚‰é™¤å¤–ã•ã‚Œã‚‹
@import '~hoge/dist/style.css';
```


[builtin:lightningcss-loader](https://rspack.dev/guide/features/builtin-lightningcss-loader#type-declarations) ã®æœ€é©åŒ–ã«ã‚ˆã‚‹æŒ™å‹•ã®ã‚ˆã†ãªã®ã§ `postcss-loader` ã«å¤‰æ›´ã—ã¦è§£æ±ºã€‚ãŸã ã€ãƒ“ãƒ«ãƒ‰é€Ÿåº¦ãŒè‹¥å¹²é…ããªã‚‹ã®ã§ã€å›é¿ç­–ã‚’æ¤œè¨ä¸­ã€‚

```diff:rspack.config.js
  {
    test: /\.(c|sc|sa)ss$/,
    use: [
      rspack.CssExtractRspackPlugin.loader,
      { loader: 'css-loader' },
-     { loader: 'builtin:lightningcss-loader' },
+     { loader: 'postcss-loader' },
      { loader: 'sass-loader' },
    ],
  },
```

## â‘¢ åŒåã®ãƒãƒƒã‚·ãƒ¥ã§å†…å®¹ãŒç•°ãªã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã‚‹
JSã®å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ `[name].[chunkhash].js` ã¨ã—ã¦ã„ã‚‹ã®ã«ã€ãªãœã‹åŒåã§å†…å®¹ã®ç•°ãªã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼ˆæœ¬æ¥ã¯ãƒãƒ£ãƒ³ã‚¯ã®å†…å®¹ãŒç•°ãªã‚Œã°ãƒãƒƒã‚·ãƒ¥ã‚‚å¤‰ã‚ã‚‹ã¯ãšï¼‰ã€‚CloudFrontçµŒç”±ã®é…ä¿¡ã§invalidateãŒé©åˆ‡ã«è¡Œã‚ã‚Œãšã€ä¸€éƒ¨éå»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒä½¿ã‚ã‚Œã¦ã—ã¾ã„ç”»é¢ãŒå£Šã‚Œã¾ã—ãŸã€‚

### å¯¾å¿œ

ãƒãƒƒã‚·ãƒ¥å½¢å¼ã‚’ `[contenthash]` ã«å¤‰æ›´ã—ã¦è§£æ±ºã€‚webpackã®ãƒ“ãƒ«ãƒ‰ã§ã¯åŒæ§˜ã®å•é¡Œã¯èµ·ã“ã‚‰ãªã„ã®ã§ã€ãŠãã‚‰ãRspackã®ãƒã‚°ã€‚å†ç¾ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¦è¿‘ã€…Issueã‚’ä¸Šã’ã‚‹äºˆå®šã§ã™ã€‚

```diff:rspack.config.js
output: {
-  filename: '[name].[chunkhash].js',
+  filename: '[name].[contenthash].js',
-  chunkFilename: '[name].[chunkhash].js',
+  chunkFilename: '[name].[contenthash].js',
}
```

ãã®ä»–ã€ä»Šå¾ŒåŒæ§˜ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥äº‹æ•…ãŒèµ·ã“ã‚‰ãªã„ã‚ˆã†ã«releaseã®CIã§ä»¥ä¸‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦åŒåã§å†…å®¹ãŒç•°ãªã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

```bash
#!/bin/bash
set -eu

# CIå´ã§PRãƒ–ãƒ©ãƒ³ãƒã¨releaseãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ã€
# ãã‚Œãã‚Œã®ãƒ“ãƒ«ãƒ‰çµæœã‚’/tmp/currentã¨/tmp/releaseã«é…ç½®ã™ã‚‹
dir1="/tmp/current"
dir2="/tmp/release"

different_files_found=0

# dir1å†…ã®å…¨ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†å¸°çš„ã«æ¢ç´¢
while IFS= read -r -d '' file1; do
    relative_path="${file1#"$dir1"/}"
    file2="$dir2/$relative_path"

    if [ -f "$file2" ]; then
        # å†…å®¹ãŒç•°ãªã‚‹ã‹æ¤œè¨¼
        if ! cmp -s "$file1" "$file2"; then
            echo "Different content: $relative_path"
            different_files_found=1
        fi
    fi
done < <(find "$dir1" -type f -print0)

if [ $different_files_found -eq 1 ]; then
    echo "ğŸš¨ åŒåã§å†…å®¹ãŒç•°ãªã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚"
    exit 1
else
    echo "âœ… åŒåã§å†…å®¹ãŒç•°ãªã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
    exit 0
fi
```

:::message
ã“ã“ã§æŒ™ã’ãŸå•é¡Œã¯ã€webpack ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ã®äº’æ›æ€§ã®å•é¡Œãªã®ã‹ã€ãã‚Œã¨ã‚‚configã®æ›¸ãæ–¹ã®å•é¡Œãªã®ã‹ã€rspackè‡ªä½“ã®å•é¡Œãªã®ã‹å¤‰æ•°ã‚‚å¤šããƒ‡ãƒãƒƒã‚¯ãŒé›£ã—ã‹ã£ãŸã§ã™ã€‚ã‚‚ã—ã‹ã—ãŸã‚‰ç§ã®èªè­˜ãŒé–“é•ã£ã¦ã„ã‚‹å ´åˆã‚‚ã‚ã‚‹ã¨æ€ã†ã®ã§ã€ãã®éš›ã¯ã‚³ãƒ¡ãƒ³ãƒˆé ‚ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ğŸ™
:::

# ğŸ’­ ãŠã‚ã‚Šã«

webpackã‹ã‚‰ç§»è¡Œã‚³ã‚¹ãƒˆã‚’æŠ‘ãˆã¦ã€ãƒ“ãƒ«ãƒ‰é€Ÿåº¦ã‚’ä¸Šã’ãŸã„ã®ãªã‚‰Rspackã¯è‰¯ã•ãã†ã§ã™ã€‚ãŸã Prodãƒ“ãƒ«ãƒ‰ã ã‘ã§èµ·ã“ã‚‹ä¸å…·åˆã‚‚ã‚ã‚Šã€ã¾ã ä¸å®‰å®šãªã®ã§ç§»è¡Œã¯æ…é‡ã«ãƒ»ãƒ»ã€‚ï¼ˆrevertã®revertã®revetã®revet PRã‚’ä½œã‚‹ãã‚‰ã„è©¦è¡ŒéŒ¯èª¤ã—ã¦ã¾ã—ãŸï¼‰

ã¾ãŸã€webpackã»ã©æˆç†Ÿã—ãŸã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã‚’æŒã¤ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã§ã‚‚ã€ã“ã†ã„ã†å½¢ã§æ–°ã—ã„ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«ã¸ç§»è¡ŒãŒé€²ã‚€ã¨æ€ã†ã¨è€ƒãˆæ·±ã„ã§ã™ã€‚æ—¢å­˜ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ãã®ã¾ã¾ä½¿ãˆã‚‹çŠ¶æ…‹ã§Rustãªã©é«˜é€Ÿãªè¨€èªã§æ›¸ãç›´ã™ã‚±ãƒ¼ã‚¹ã¯ä»Šå¾Œã‚‚å¢—ãˆã¦ã„ããã†ã§ã™ã­ã€‚ä»ŠViteã§é€²ã‚“ã§ã„ã‚‹ [Rollup](https://rollupjs.org/) -> [Rolldown](https://rolldown.rs/)ã‚‚ãã®ä¸€ä¾‹ã‹ã‚‚ã¨æ€ã„ã¾ã—ãŸã€‚
