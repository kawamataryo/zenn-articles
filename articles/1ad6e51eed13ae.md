---
title: "VanJS ã§ç´ ã®DOMæ“ä½œã‚’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ã—ã¦ã¿ãŸ"
emoji: "ğŸ¦"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["vanjs", "javascript", "typescript"]
published: true
---

VanJSã‚’è©¦ã—ã¦ã¿ãŸã‚‰é–‹ç™ºä½“é¨“ãŒè‰¯ã‹ã£ãŸã®ã§ç´¹ä»‹ã—ã¾ã™ã€‚

# ğŸ¦ VanJSã¨ã¯ï¼Ÿ

[VanJS](https://vanjs.org/)ã¯ã€æ•°ãƒ¶æœˆå‰ã«ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸæ¯”è¼ƒçš„æ–°ã—ã„Reactive UIãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚è»½é‡ã€éä¾å­˜ã€ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ä¸è¦ã€ã‚·ãƒ³ãƒ—ãƒ«ãªAPIã¨ã„ã†ç‰¹å¾´ãŒã‚ã‚Šã¾ã™ã€‚

https://vanjs.org/

gzipåœ§ç¸®å¾Œã§**0.9kbã¨éå¸¸ã«è»½é‡**ã§ã€ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã®è‚¥å¤§åŒ–ã‚’æ°—ã«ã™ã‚‹ã“ã¨ãªãæ‰‹è»½ã«å°å…¥ã§ãã¾ã™ã€‚

![](/images/1ad6e51eed13ae/2023-08-17-07-34-28.png)
*ä»–ã®UIãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨æ¯”è¼ƒã—ã¦ã‚‚åœ§å€’çš„ã«è»½é‡*

UIã‚‚JSXã‚’ä½¿ã‚ãšã€é–¢æ•°ãƒ™ãƒ¼ã‚¹ã®APIã§å®£è¨€çš„ã«æ§‹ç¯‰ã§ãã¾ã™ã€‚

@[jsfiddle](https://jsfiddle.net/ryokawamata0425/fh7aLkcp/)

VanJSã®é–‹ç™ºç§˜è©±ã¯ã¨ã¦ã‚‚è€ƒãˆã•ã›ã‚‰ã‚Œã‚‹ã‚‚ã®ã ã£ãŸã®ã§ã€æ©Ÿä¼šãŒã‚ã‚Œã°ãœã²èª­ã‚“ã§ã¿ã¦ãã ã•ã„ã€‚
https://vanjs.org/about


# ğŸ› ï¸ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¯¾è±¡

[Sky Follower Bridge](https://chrome.google.com/webstore/detail/sky-follower-bridge/behhbpbpmailcnfbjagknjngnfdojpko)ã¨ã„ã†X(Twitter)ã®Followerä¸€è¦§ã‹ã‚‰[Bluesky](https://bsky.app/)ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢ã™ã‚‹Chromeæ‹¡å¼µã‚’å€‹äººé–‹ç™ºã—ã¦ã„ã¾ã™ã€‚ä»Šå›ã¯ãã®æ‹¡å¼µæ©Ÿèƒ½ã®content scriptã®éƒ¨åˆ†ã‚’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¯¾è±¡ã¨ã—ã¾ã—ãŸã€‚

https://www.youtube.com/watch?v=XcRcWjStIMc

https://github.com/kawamataryo/sky-follower-bridge

https://www.sky-follower-bridge.dev/

ã“ã®æ‹¡å¼µæ©Ÿèƒ½ã¯X(Twitter)ã®DOMè¦ç´ ã‚’åŸºæº–ã«å‹•çš„ã«Blueskyã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒ«ã‚’è¿½åŠ ã™ã‚‹ã®ã§ã™ãŒã€å¯¾è±¡è¦ç´ ã«Reactã‚„Vueã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’éƒ½åº¦ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã®ã‚‚ä½•ã‹é•å’Œæ„ŸãŒã‚ã‚‹ãªã¨ã€é–‹ç™ºå½“åˆã¯ç´ ã®DOMæ“ä½œã§å®Ÿè£…ã—ã¦ã„ã¾ã—ãŸã€‚

![](/images/1ad6e51eed13ae/2023-08-17-08-54-41.png)

ã—ã‹ã—ã€æ©Ÿèƒ½ãŒå¢—ãˆã‚‹ã«ã¤ã‚Œã‚³ãƒ¼ãƒ‰ãŒè¤‡é›‘åŒ–ã—å¯èª­æ€§ã«å•é¡ŒãŒå‡ºã¦ãã¾ã—ãŸã€‚ãã“ã§ã€è»½é‡ã§ã‚·ãƒ³ãƒ—ãƒ«ãªVanJSã‚’ä½¿ã„ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚


# ğŸ“ çµæœ

Blueskyã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒ«ã®æŒ¿å…¥ç®‡æ‰€ã‚’ä¾‹ã«ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°çµæœã‚’ç´¹ä»‹ã—ã¾ã™ã€‚
å®Ÿéš›ã®VanJSã®å°å…¥PRã¯ã“ã¡ã‚‰ã§ã™ã€‚

https://github.com/kawamataryo/sky-follower-bridge/pull/7

## Before

ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å‰ã®ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚

```ts:src/lib/domHelpers.ts
export const insertBskyProfileEl = ({ dom, profile, statusKey, btnLabel, abortController, followAction, unfollowAction }: {
  dom: Element,
  profile: ProfileView,
  statusKey: keyof ViewerState,
  btnLabel: UserCellBtnLabel,
  abortController: AbortController,
  followAction: () => void,
  unfollowAction: () => void
}) => {
  const avatarEl = profile.avatar ? `<img src="${profile.avatar}" width="48" />` : "<div class='no-avatar'></div>"
  const actionBtnEl = profile.viewer[statusKey] ? `<button class='follow-button follow-button__following'>${btnLabel.progressive} on Bluesky</button>` : `<button class='follow-button'>${btnLabel.add} on Bluesky</button>`
  dom.insertAdjacentHTML('afterend', `
  <div class="bsky-user-content">
    <div class="icon-section">
      <a href="https://bsky.app/profile/${profile.handle}" target="_blank" rel="noopener">
        ${avatarEl}
      </a>
    </div>
    <div class="content">
      <div class="name-and-controller">
        <div>
          <p class="display-name"><a href="https://bsky.app/profile/${profile.handle}" target="_blank" rel="noopener">${profile.displayName ?? profile.handle}</a></p>
          <p class="handle">@${profile.handle}</p>
        </div>
        <div>
          ${actionBtnEl}
        </div>
      </div>
      ${profile.description ? `<p class="description">${profile.description}</p>` : ""}
    </div>
  </div>
  `)
  const bskyUserContentDom = dom.nextElementSibling as Element

  // register a click action
  bskyUserContentDom?.addEventListener('click', async (e) => {
    const target = e.target as Element
    const classList = target.classList

    // follow action
    if (classList.contains('follow-button') && !classList.contains('follow-button__following')) {
      target.textContent = "processing..."
      target.classList.add('follow-button__processing')
      await followAction()
      target.textContent = `${btnLabel.progressive} on Bluesky`
      target.classList.remove('follow-button__processing')
      target.classList.add('follow-button__following')
      target.classList.add('follow-button__just-followed')
      return
    }

    // unfollow action
    if (classList.contains('follow-button') && classList.contains('follow-button__following')) {
      target.textContent = "processing..."
      target.classList.add('follow-button__processing')
      await unfollowAction()
      target.textContent = `${btnLabel.add} on Bluesky`
      target.classList.remove('follow-button__processing')
      target.classList.remove('follow-button__following')
      return
    }
  }, {
    signal: abortController.signal
  })

  bskyUserContentDom?.addEventListener('mouseover', async (e) => {
    const target = e.target as Element
    const classList = target.classList
    if (classList.contains('follow-button') && classList.contains('follow-button__following')) {
      target.textContent = `${btnLabel.remove} on Bluesky`
    }
  }, {
    signal: abortController.signal
  })
  bskyUserContentDom?.addEventListener('mouseout', async (e) => {
    const target = e.target as Element
    const classList = target.classList
    if (classList.contains('follow-button__just-followed')) {
      target.classList.remove('follow-button__just-followed')
    }
    if (classList.contains('follow-button') && classList.contains('follow-button__following')) {
      target.textContent = `${btnLabel.progressive} on Bluesky`
    }
  }, {
    signal: abortController.signal
  })
}
```

`insertAdjacentHTML`ã§æ¡ä»¶ã«åˆã‚ã›ãŸDOMã‚’æ§‹ç¯‰ã€`addEventListener`ã§clickã‚¤ãƒ™ãƒ³ãƒˆã¨ã€hoverã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™»éŒ²ã—ã¦ã„ã¾ã™ã€‚

Reactiveãªå‹•ä½œã¯ä¸»ã«ãƒœã‚¿ãƒ³ã«é›†ä¸­ã—ã¦ã„ã‚‹ã®ã§ã™ãŒã€ã“ã®ãƒœã‚¿ãƒ³ã®æŒ™å‹•ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«DOM APIã§ç›´æ¥ã‚¯ãƒ©ã‚¹ã®ä»˜ã‘å¤‰ãˆã‚„ãƒ†ã‚­ã‚¹ãƒˆã®æ›¸ãæ›ãˆã‚’è¡Œãªã£ã¦ã„ã¾ã™ã€‚UIã¨ã‚¤ãƒ™ãƒ³ãƒˆã®é–¢é€£ãŒåˆ†ã‹ã‚Šã«ããã€æ›¸ã„ãŸæœ¬äººãªãŒã‚‰ã‚ã¾ã‚Šè§¦ã‚ŠãŸããªã„ã‚³ãƒ¼ãƒ‰ã§ã™ğŸ˜…

![](/images/1ad6e51eed13ae/button.gif)



## After

VanJSã§ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¾Œã§ã™ã€‚

ãƒ»Mount

```ts:src/lib/domHelpers.ts
export const insertBskyProfileEl = ({ dom, profile, statusKey, btnLabel, addAction, removeAction }: {
  dom: Element,
  profile: ProfileView,
  statusKey: keyof ViewerState,
  btnLabel: UserCellBtnLabel,
  addAction: () => Promise<void>,
  removeAction: () => Promise<void>
}) => {
  van.add(dom.parentElement, BskyUserCell({
    profile,
    statusKey,
    btnLabel,
    addAction,
    removeAction,
  }))
}
```

ãƒ»ActionButton

```ts:src/components/BskyUserCell.ts
const ActionButton = ({ statusKey, profile, btnLabel, addAction, removeAction }: {
  profile: ProfileView,
  statusKey: keyof ViewerState,
  btnLabel: UserCellBtnLabel,
  addAction: () => Promise<void>,
  removeAction: () => Promise<void>
}) => {
  const label = van.state(`${profile.viewer[statusKey] ? btnLabel.progressive : btnLabel.add} on Bluesky`)

  const isStateOfBeing = van.state(profile.viewer[statusKey])
  const isProcessing = van.state(false)
  const isJustApplied = van.state(false)

  const beingClass = van.derive(() => isStateOfBeing.val ? "action-button__being" : "")
  const processingClass = van.derive(() => isProcessing.val ? "action-button__processing" : "")
  const justAppliedClass = van.derive(() => isJustApplied.val ? "action-button__just-applied" : "")

  const onClick = async () => {
    if (isProcessing.val) return
    isProcessing.val = true
    label.val = "Processing..."

    if (isStateOfBeing.val) {
      await removeAction()
      label.val = `${btnLabel.add} on Bluesky`
      isStateOfBeing.val = false
    } else {
      await addAction()
      label.val = `${btnLabel.progressive} on Bluesky`
      isStateOfBeing.val = true
      isJustApplied.val = true
    }

    isProcessing.val = false
  }

  const onMouseover = () => {
    if(
      isProcessing.val ||
      isJustApplied.val ||
      !isStateOfBeing.val
    ) return

    label.val = `${btnLabel.remove} on Bluesky`
  }

  const onMouseout = () => {
    if (isJustApplied.val) {
      isJustApplied.val = false
    }
    if(!isStateOfBeing.val) return

    label.val = `${btnLabel.progressive} on Bluesky`
  }

  return button({
    class: () => `action-button ${beingClass.val} ${processingClass.val} ${justAppliedClass.val}`,
    onclick: onClick,
    onmouseover: onMouseover,
    onmouseout: onMouseout,
  },
    () => label.val,
  )
}
```

ãƒ»BskyUserCell

```ts:src/components/BskyUserCell.ts
const Avatar = ({ avatar }: { avatar?: string }) => {
  return avatar ? img({ src: avatar, width: "40" }) : div({ class: "no-avatar" })
}

export const BskyUserCell = ({
  profile,
  statusKey,
  btnLabel,
  addAction,
  removeAction,
}: {
  profile: ProfileView,
  statusKey: keyof ViewerState,
  btnLabel: UserCellBtnLabel,
  addAction: () => Promise<void>,
  removeAction: () => Promise<void>
}) => {
  return div({ class: "bsky-user-content" },
    div({ class: "icon-section"},
      a({ href: `https://bsky.app/profile/${profile.handle}`, target: "_blank", rel: "noopener" },
        Avatar({ avatar: profile.avatar }),
      ),
    ),
    div({ class: "content" },
      div({ class: "name-and-controller" },
        div(
          p({ class: "display-name" },
            a({ href: `https://bsky.app/profile/${profile.handle}`, target: "_blank", rel: "noopener" },
              profile.displayName ?? profile.handle,
            ),
          ),
          p({ class: "handle" },
            `@${profile.handle}`,
          ),
        ),
        div(
          ActionButton({
            profile,
            statusKey,
            btnLabel,
            addAction,
            removeAction,
          })
        ),
      ),
      profile.description ? p({ class: "description" }, profile.description) : "",
    ),
  )
}
```

ãƒã‚¦ãƒ³ãƒˆå‡¦ç†ã¯ã€å¯¾è±¡ã®DOMã«`van.add`ã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã®ã¿ã€‚VanJSã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå´ã‚‚ã€è¦ªã—ã¿ã‚ã‚‹Vueã‚„Reactã®ã‚ˆã†ã«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’åˆ†å‰²ã—å®£è¨€çš„ã«UIã‚’æ§‹ç¯‰ã§ãã¾ã—ãŸã€‚

ReactiveãªæŒ™å‹•ã‚’æŒã¤ãƒœã‚¿ãƒ³ã‚‚ã€`van.state`ã§çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ã“ã¨ã§ã‚¤ãƒ™ãƒ³ãƒˆã¨UIã®é–¢é€£ãŒä¸€ç›®ã§ã‚ã‹ã‚Šã€ã ã„ã¶å¯èª­æ€§ã¯è‰¯ããªã£ãŸæ°—ãŒã—ã¾ã™ã€‚

ä»Šå¾Œã®æ©Ÿèƒ½æ‹¡å¼µã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚ä¸ŠãŒã‚Šã¾ã—ãŸğŸ’ª

# ğŸ‘‹ ãŠã‚ã‚Šã«
VanJSã¯ `VanJS is the scripting language for UI, just like bash is the scripting language for terminal.`  ã¨ã„ã†èª¬æ˜ã®é€šã‚Šã€æ‰‹è»½ã«ReactiveãªUIãŒæ§‹ç¯‰ã§ãã¦æœ€é«˜ã§ã—ãŸã€‚

ä»Šå›ã®ä¾‹ã®ã‚ˆã†ãªChrome Extensionã®content scriptã‚„ã€é™çš„ã‚µã‚¤ãƒˆã®ã¡ã‚‡ã£ã¨ã—ãŸUIã®å®Ÿè£…ãªã©ã€ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆã§Reactiveãªå‹•ãã‚’å®Ÿç¾ã—ãŸã„æ™‚ã«ã¯ã€ã¨ã¦ã‚‚è‰¯ã„é¸æŠè‚¢ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚ãœã²ä½¿ã£ã¦è¦‹ã¦ãã ã•ã„ã€‚
