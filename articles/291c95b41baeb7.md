---
title: "OpenAPIã®GPT-3ã‚’ä½¿ã£ã¦ã€ChatGPTãƒ©ã‚¤ã‚¯ã«ä¼šè©±ãŒã§ãã‚‹SlackBotã‚’ä½œã‚‹"
emoji: "ğŸ¤–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["slack", "chatgpt", "gpt3", "openapi"]
published: false
---

# ğŸ¤– ä½œã£ãŸã‚‚ã®

[OpenAI](https://openai.com/) ãŒæä¾›ã—ã¦ã„ã‚‹ [GPT-3](https://openai.com/blog/gpt-3-apps/) ã‚’åˆ©ç”¨ã—ã¦ã€Slack ã§ ChatGPT ãƒ©ã‚¤ã‚¯ã«ä¼šè©±ãŒã§ãã‚‹ SlackBot ã‚’ä½œã‚Šã¾ã—ãŸã€‚

ChatGPT ã®ã‚ˆã†ã«**å‰ã®ä¼šè©±ã‚’è€ƒæ…®ã—ã¦å›ç­”ã—ã¦ãã‚Œã‚‹**ãã‚Œã‚‹ã¨ã“ã‚ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

![](/images/291c95b41baeb7/demo.gif)

# ğŸ› ï¸ å®Ÿè£…

å‰ã®ä¼šè©±ã‚’è€ƒæ…®ã—ã¦è¿”ç­”ã—ã¦ãã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹å®Ÿè£…ã®è‚ **prompt** ã§ã™ã€‚

æ¯å›ä»¥ä¸‹ã®ã‚ˆã†ãª prompt ã‚’ OpenAPI ã® [Completion API](https://platform.openai.com/docs/api-reference/completions) ã«æ¸¡ã™ã“ã¨ã§ã€å‰ã®ä¼šè©±ã‚’è€ƒæ…®ã—ãŸå›ç­”ã‚’ã‚‚ã‚‰ã£ã¦ã„ã¾ã™ã€‚

`prevMessageText` ã®å¤‰æ•°ã«ã¯ Slack ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã®å‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚’ã¾ã¨ã‚ãŸæ–‡å­—åˆ—ã‚’æ¸¡ã—ã¾ã™ã€‚
`text`ã®éƒ¨åˆ†ãŒä»Šå›ã®è³ªå•ã§ã™ã€‚

```ts
const prompt = `
ã‚ãªãŸã¯å„ªç§€ãªSlackBotã§ã™ã€‚ã‚ãªãŸã®çŸ¥è­˜ã¨ã“ã‚Œã¾ã§ã®ä¼šè©±ã®å†…å®¹ã‚’è€ƒæ…®ã—ãŸä¸Šã§ã€ä»Šã®è³ªå•ã«æ­£ç¢ºãªå›ç­”ã‚’ã—ã¦ãã ã•ã„ã€‚

### ã“ã‚Œã¾ã§ã®ä¼šè©±:
${prevMessageText}

### ä»Šã®è³ªå•:
${text}

### ä»Šã®è³ªå•ã®å›ç­”:
`;
```

ä»¥ä¸‹ Slack ã®[Bolt ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯](https://slack.dev/bolt-js/concepts) ã‚’ã¤ã‹ã£ãŸå ´åˆã®å®Ÿè£…ä¾‹ã§ã™ã€‚

```ts
export const useReplyEvent = (app: App) => {
  app.event("message", async ({ event, client, logger }) => {
    const { thread_ts: threadTs, bot_id: botId, text } = event as any;
    // botã®è¿”ä¿¡ã¾ãŸã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
    if (botId || !threadTs) {
      return;
    }

    // ã‚¹ãƒ¬ãƒƒãƒ‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
    const threadMessagesResponse = await client.conversations.replies({
      channel: event.channel,
      ts: threadTs,
    });
    const messages = threadMessagesResponse.messages?.sort(
      (a, b) => Number(a.ts) - Number(b.ts)
    );

    // GPT Botã¸ã®è¿”ä¿¡ã§ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
    if (!(messages![0].text?.includes(GPT_BOT_NAME) && messages![0].bot_id)) {
      return;
    }

    try {
      // Slackã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹åˆ¶ç´„ã‚’å›é¿ã™ã‚‹ãŸã‚ã«ã€ä»®ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ç¨¿ã™ã‚‹
      const thinkingMessageResponse = await postAsGptBot({
        client,
        channel: event.channel,
        threadTs,
        text: "...",
      });

      // ä¼šè©±ã®å±¥æ­´ã‚’å–å¾—ã—ã¦çµåˆã€‚æœ€å¤§6ä»¶ã¾ã§
      const prevMessages =
        messages!.length < 6 ? messages!.slice(1, -1) : messages!.slice(-6, -1);
      const prevMessageText =
        prevMessages.map((m) => `- ${m.text}`).join("\n") || "";

      // å›ç­”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä½œæˆ with OpenAI
      const prompt = `
ã‚ãªãŸã¯å„ªç§€ãªSlackBotã§ã™ã€‚ã‚ãªãŸã®çŸ¥è­˜ã¨ã“ã‚Œã¾ã§ã®ä¼šè©±ã®å†…å®¹ã‚’è€ƒæ…®ã—ãŸä¸Šã§ã€ä»Šã®è³ªå•ã«æ­£ç¢ºãªå›ç­”ã‚’ã—ã¦ãã ã•ã„ã€‚

### ã“ã‚Œã¾ã§ã®ä¼šè©±:
${prevMessageText}

### ä»Šã®è³ªå•:
${text}

### ä»Šã®è³ªå•ã®å›ç­”:
`;
      const configuration = new Configuration({
        apiKey: config.openai.key,
      });
      const openAIClient = new OpenAIApi(configuration);
      const completions = await openAIClient.createCompletion({
        model: "text-davinci-003",
        prompt: prompt,
        max_tokens: 1000,
        top_p: 0.5,
        frequency_penalty: 1,
      });
      const message = completions.data.choices[0].text;

      // ä»®ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã™ã‚‹
      await client.chat.delete({
        channel: event.channel,
        ts: thinkingMessageResponse.ts!,
      });

      // å›ç­”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ç¨¿ã™ã‚‹
      if (message) {
        await postAsGptBot({
          client,
          channel: event.channel,
          threadTs,
          text: message,
        });
      } else {
        throw new Error("message is empty");
      }
    } catch (e) {
      logger.error(e);
      await postAsGptBot({
        client,
        channel: event.channel,
        threadTs,
        text: "å¤§å¤‰ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚",
      });
    }
  });
};
```

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿéš›ã«å®Ÿè£…ã—ãŸ PR ã§ã™ã€‚

https://github.com/kawamataryo/tell-me-bot/pull/11

ä»¥å‰è¨˜äº‹ã§ç´¹ä»‹ã—ãŸ tell-me-bot ã¨ã„ã†ä¾¿åˆ©ãªè³ªå•å›ç­” Bot ã«ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚

https://b.hatena.ne.jp/entry/s/zenn.dev/ryo_kawamata/articles/tell-me-bot-slack-app

# çµ‚ã‚ã‚Šã«

prompt ã‚’å°‘ã—å·¥å¤«ã™ã‚‹ã“ã¨ã§ã€æ¯å›å˜ç™ºã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãªãŒã‚‰ä¼šè©±ãŒãªã‚ŠãŸã£ã¦ã„ã‚‹ã‚ˆã†ã«ã™ã‚‹ç‚¹ãªã©ã€prompt ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã‚’ã¨ã¦ã‚‚æ„Ÿã˜ã‚‹ä½“é¨“ã§ã—ãŸã€‚ã„ã‚ã„ã‚è€ƒãˆã•ã›ã‚‰ã‚Œã¾ã™ã­ã€‚
